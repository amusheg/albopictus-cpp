---
title: "GDD Deadlines Japan/US 1998-2018"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

Naresh and Leslie compiled some additional climate parameters: monthly mean maximum and minimum temperatures in the US and Japan locations, 1998-2008, as well as calculating values we are calling GDD400 and GDD465: the latest days of the year on which there are 400 (or 465) growing degree days left in the year. These "deadline" values were selected based on values for temperature-dependent development rates in the literature. The climate data come from the Climate Prediction Center (CPC) and have a resolution of about 50 sq km. The data for Okinawa come from...?


```{r include=FALSE}
library(tidyverse)
library(drc)
library(cowplot)
```

# GDD deadline data

```{r}
#importing and reshaping table
gdd400_us <- read.csv("GDD400_US.csv", check.names=FALSE) %>% gather(year, gdd400, "1998":"2018", factor_key=FALSE)
gdd400_us$year<-as.numeric(gdd400_us$year)
ggplot(gdd400_us, aes(x=year, y=gdd400, color=pop)) + geom_point() + geom_line() + geom_vline(xintercept=c(2008,2018))

```
```{r}
gdd400_jp <- read.csv("GDD400_JP.csv", check.names=FALSE) %>% gather(year, gdd400, "1998":"2018", factor_key=FALSE)
gdd400_jp$year<-as.numeric(gdd400_jp$year)

```

```{r}
#adding latitudes
locations<-read.csv("mapping_pops_cpp_expt.csv")
gdd400_us<-left_join(gdd400_us, dplyr::select(locations, pop, latitude, country, only_2008), by=c("pop"))
gdd400_jp<-left_join(gdd400_jp, dplyr::select(locations, pop, latitude, country, only_2008), by=c("pop"))
gdd400_all<-rbind(gdd400_us, gdd400_jp)
gdd400_all$pop<-as.factor(gdd400_all$pop)
gdd400_all<-mutate(gdd400_all, interval=case_when(year<=2017 & year>=2008 ~ 'y2008-2017',
                                                  year<2008 ~ 'y1998-2007'))
```

## GDD deadline by latitude in Japan and US

NB: In the US, the same sites were sampled in 2008 and 2018. In Japan, some sites were different between 2008 and 2018. The following graphs show only the 2018 sites over all years.

```{r}
ggplot(filter(gdd400_all, year>2014, only_2008=="n"), aes(x=latitude, y=gdd400, color=country)) + geom_point() + facet_wrap(~year)
```

```{r}
ggplot(filter(gdd400_all, year<2008, only_2008=="n"), aes(x=latitude, y=gdd400, color=country)) + geom_point() + facet_wrap(~year)

```
```{r}
ggplot(filter(gdd400_all, year>=2008, only_2008=="n"), aes(x=latitude, y=gdd400, color=country)) + geom_point() + facet_wrap(~year)

```
```{r}
ggplot(filter(gdd400_all, only_2008=="n", year!=2018), aes(x=latitude, y=gdd400, fill=country)) + scale_fill_manual(values=c("black", "gray"), name="Country") + geom_point(shape=21) + facet_wrap(~year) + xlab("Latitude") + ylab("GDD Deadline (ordinal day)") + theme_bw() + theme(legend.position="bottom")

```


```{r}
gdd400_all$interval<-as.factor(gdd400_all$interval)
```

## GDD deadlines 1998-2007 vs. 2008-2017

```{r}
ggplot(filter(gdd400_all, country=="US", interval!="NA"), aes(x=interval, y=gdd400)) + geom_point(position=position_jitter()) + geom_boxplot(alpha=0) + facet_wrap(~pop)
```

```{r}
ggplot(filter(gdd400_all, country=="JP", interval!="NA", only_2008=="n"), aes(x=interval, y=gdd400)) + geom_point(position=position_jitter()) + geom_boxplot(alpha=0) + facet_wrap(~pop)

```

## GDD deadlines including 2008 Japan sites


```{r}
ggplot(filter(gdd400_all, year %in% c(2005, 2006, 2007, 2015, 2016, 2017)), aes(x=latitude, y=gdd400, color=country)) + geom_point() + facet_wrap(~year)
```

Notable: the point at ~30 degrees lat in Japan has a later GDD deadline than the other sites in Japan. This population, TAN (Tanegashima, located on a small island), was also an outlier in the 2008 CPP experiment, with a CPP value in the range of the US values:

![figures/CPP_year_country.png](figures/CPP_year_country.png)
![Urbanski_08cpp.png](figures/Urbanski_08cpp.png)

# Minimum average Tmin of winter months


```{r}
tmin_us<-read.csv("AvgTmin_US.csv", check.names=FALSE) %>% gather(year, Tmin, "1998":"2018", factor_key=FALSE)
#In order to look at winter temperatures, need to combine Nov/Dec with Jan/Feb of the following year. January and February are reassigned in this table to the previous year to create seasonal years
tmin_us$year<-as.numeric(tmin_us$year) 
tmin_us$seasonalyear<-if_else(tmin_us$month %in% c("Jan","Feb"), tmin_us$year-1, tmin_us$year)
minwintertemp_us<-filter(tmin_us, month %in% c("Nov","Dec","Jan","Feb")) %>% group_by(pop, seasonalyear) %>% dplyr::summarise(wintermin=min(Tmin), wintermonths_sd=sd(Tmin)) %>% filter(!(seasonalyear %in% c(1997,2018)))
ggplot(minwintertemp_us, aes(x=seasonalyear, y=wintermin, color=pop)) + geom_point() + geom_line() + geom_vline(xintercept=c(2008,2018)) 
```
```{r}
ggplot(minwintertemp_us, aes(x=seasonalyear, y=wintermonths_sd, color=pop)) + geom_point() + geom_line() + geom_vline(xintercept=c(2008,2018)) 

```


```{r}
tmin_jp<-read.csv("AvgTmin_JP.csv", check.names=FALSE) %>% gather(year, Tmin, "1998":"2018", factor_key=FALSE)
tmin_jp$year<-as.numeric(tmin_jp$year) 
tmin_jp$seasonalyear<-if_else(tmin_jp$month %in% c("Jan","Feb"), tmin_jp$year-1, tmin_jp$year)
minwintertemp_jp<-filter(tmin_jp, month %in% c("Nov","Dec","Jan","Feb")) %>% group_by(pop, seasonalyear) %>% dplyr::summarise(wintermin=min(Tmin), wintermonths_sd=sd(Tmin)) %>% filter(!(seasonalyear %in% c(1997,2018)))
ggplot(minwintertemp_jp, aes(x=seasonalyear, y=wintermin, color=pop)) + geom_point() + geom_line() + geom_vline(xintercept=c(2008,2018))
```
```{r}
ggplot(minwintertemp_jp, aes(x=seasonalyear, y=wintermonths_sd, color=pop)) + geom_point() + geom_line() + geom_vline(xintercept=c(2008,2018))

```

```{r}
wintermin_all<-rbind(minwintertemp_us, minwintertemp_jp)
gdd400_all_new<-left_join(gdd400_all, wintermin_all, by=c("pop"="pop", "year"="seasonalyear"))
gdd400_all_new$pop<-as.factor(gdd400_all_new$pop)

```
## Winter coldness by latitude in US and Japan

Winter coldness looks similar in US and Japan. Previous data showed that *absolute* minumum temperature is colder in US than Japan (see Urbanski 2012 appendix). Note: these graphs include only the Japanese sites sampled in 2018. Also note: the winter prior to summer 2018 (i.e. Nov and Dec 2017 + Jan and Feb 2018) is labeled as year 2017 for this value

```{r}
ggplot(filter(gdd400_all_new, interval=="y1998-2007", only_2008=="n"), aes(x=latitude, y=wintermin, color=country)) + geom_point() + facet_wrap(~year) 
```

```{r}
ggplot(filter(gdd400_all_new, interval=="y2008-2017", only_2008=="n"), aes(x=latitude, y=wintermin, color=country)) + geom_point() + facet_wrap(~year)

```

## Winter coldness 1998-2007 vs. 2008-2017

```{r}
ggplot(filter(gdd400_all_new, country=="US", interval!="NA"), aes(x=interval, y=wintermin)) + geom_point(position=position_jitter()) + geom_boxplot(alpha=0) + facet_wrap(~pop)
```


## Winter 2007 vs. 2017
These are the winters immediately preceding the summer populations were collected for the study. ALL Japanese sites are included here.

```{r}
ggplot(filter(gdd400_all_new, year %in% c(2007,2017), only_2008=="n"), aes(x=latitude, y=wintermin, color=as.factor(year))) + geom_point() + facet_grid(~country) + scale_color_manual(values=c("blue","orange"))

```
## Winter 2006 vs. 2016
All Japanese sites included

```{r}
ggplot(filter(gdd400_all_new, year %in% c(2006,2016), only_2008=="n"), aes(x=latitude, y=wintermin, color=as.factor(year))) + geom_point() + facet_grid(~country) + scale_color_manual(values=c("blue","orange"))

```
## Winter 2005 vs. 2015

```{r}
ggplot(filter(gdd400_all_new, year %in% c(2005,2015)), aes(x=latitude, y=wintermin, color=as.factor(year))) + geom_point() + facet_grid(~country) + scale_color_manual(values=c("blue","orange"))

```

```{r}
#adding 2008 and 2018 CPP values to big table of yearly deadlines and winter temps
cpp_year<-dplyr::select(read.csv("cpp_calcs_filtered.csv"), pop, Estimate, year) %>% filter(year!="1988") %>% rename("CPP_YEAR"="year")
gdd400_all_new<-left_join(gdd400_all_new, cpp_year, by="pop")
gdd400_all_new$CPP_YEAR<-as.factor(gdd400_all_new$CPP_YEAR)

```

# 2008 and 2018 CPP estimates vs GDD deadline 

```{r}

gdd_08 <- ggplot(filter(gdd400_all_new, year==2007, CPP_YEAR==2008), aes(x=gdd400, y=Estimate, fill=country)) + scale_fill_manual(values=c("black","gray"), name="Country") + geom_point(size=3, shape=21) + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black","gray"), name="Country") +
  theme_bw() + theme(legend.position="none", text=element_text(size=14)) +
  xlab("GDD Deadline (ordinal day), 2007") + ylab("Critical photoperiod (h), 2008")

gdd_18 <- ggplot(filter(gdd400_all_new, year==2017, CPP_YEAR==2018), aes(x=gdd400, y=Estimate, fill=country)) + scale_fill_manual(values=c("black","gray"), name="Country") + geom_point(size=3, shape=21) + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black","gray"), name="Country") +
theme_bw() + theme(legend.position=c(.8,.8), text=element_text(size=14)) +
xlab("GDD Deadline (ordinal day), 2017") + ylab("Critical photoperiod (h), 2018")

plot_grid(gdd_08, gdd_18, labels="AUTO")

```



```{r}
ggplot(filter(gdd400_all_new, year==2007, CPP_YEAR==2018), aes(x=latitude, y=Estimate, color=country)) + geom_point() + stat_smooth(method=lm) 

```

```{r}
#model comparison of gdd-cpp relationship, with and without country as factor
data_18<-filter(gdd400_all_new, year==2007, CPP_YEAR==2018)
model1<-lm(Estimate~gdd400, data=data_18)
model2<-lm(Estimate~gdd400*country, data=data_18)
anova(model1, model2)

model3<-lm(Estimate~latitude, data=data_18)
model4<-lm(Estimate~latitude*country, data=data_18)
anova(model3, model4)
```


```{r}
ggplot(filter(gdd400_all_new, year %in% c(2007,2017)), aes(x=gdd400, y=Estimate, color=CPP_YEAR)) + scale_color_manual(values=c("gray", "black")) + geom_point() + facet_wrap(~year) + stat_smooth(method=lm)
```

# Variability (SD) in winter coldness in 1998-2007 vs. 2008-2017

```{r, include=FALSE}
variation_summary<-filter(gdd400_all_new, interval!="NA", CPP_YEAR=="2018") %>% group_by(pop, interval) %>% dplyr::summarize(lat=mean(latitude), country=first(country), gdd400_sd=sd(gdd400), wintermin_sd=sd(wintermin), cpp_2018=mean(Estimate))
ggplot(variation_summary, aes(x=lat, y=wintermin_sd, color=interval)) + geom_point() + facet_grid(~country)
```

# 2015 Diapause Incidence Field Trial

```{r}
field_data<-read.csv("DI_2015_FIELD.csv")
field_data$WeekDate <- reorder(field_data$WeekDate, field_data$Week)
ggplot(field_data, aes(x=WeekDate, y=DI, fill=Eggs)) + geom_point(size=3, shape=21) + scale_fill_manual(values=c("white","grey"), name="Mosquito Population") + theme_bw() + 
theme(legend.position=c(.2,.8), axis.text.x = element_text(angle = 90, hjust = 1)) +
xlab("Week") + ylab("Diapause incidence") + geom_vline(aes(xintercept=10.39), linetype="dotted", color="grey") + geom_vline(aes(xintercept=9.99), linetype="dotted", color="black")

field.model.fit <- drm(DI ~ Week, data = field_data, curveid = Eggs, fct = LL.5())
summary(field.model.fit)
# estimate the 50% intercept
cpp_field<-data.frame(ED(field.model.fit, 50))

```

