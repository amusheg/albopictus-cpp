---
title: "CPP_analysis"
output:
  html_document: default
  pdf_document: default
  word_document: default
---


```{r message=FALSE, include=FALSE}
install.packages("knitr")
install.packages("tidyverse") #1.2.1
install.packages("drc") #3.0.1
install.packages("stringr")
install.packages("geosphere")
install.packages("lubridate")
```

```{r message=FALSE}
library("drc") #3.0.1
library("knitr") #1.25
library("tidyverse") #1.2.1
library("stringr") #1.4.0
library("geosphere") #1.5.10
library("lubridate") #1.7.4
```

```{r datasheet}
all_data<-data.frame(read.csv("CPP_experiment_data_collated.csv"))
#Filter out empty/discarded oviposition papers 
blockAB<-dplyr::filter(all_data, TotalLarvaeEmbryos>0)
```

```{r yields}
#Calculate yield/fraction of initial count
blockAB$yield <- blockAB$TotalLarvaeEmbryos/blockAB$InitialEggs 
hist(blockAB$yield, main="Yield (final/initial count) per oviposition paper")
plot(blockAB$yield ~ blockAB$TotalLarvaeEmbryos)
```

```{r filter papers}
#removing papers with <60% or >100% initial count
blockAB_unfiltered<-blockAB
blockAB_filtered <- filter(blockAB, yield<=1) %>% filter(yield>=0.6) 
```


```{r summarize}

DI_summarize <- function(blockAB) {
DI_summary <- blockAB %>% 
  group_by(CageID) %>% 
  summarise(pop=first(Population), pp=mean(Photoperiod), lat=mean(Lat), block=first(Block), country=first(Country), h1=sum(H1Count), h2=sum(H2Count), emb=sum(EmbryoCount)) %>% 
  filter(h1+h2+emb>100)
DI_summary$total<-DI_summary$h1+DI_summary$h2+DI_summary$emb
DI_summary$DI<-DI_summary$emb/DI_summary$total
return(DI_summary)
}

```

```{r}
DI_summary<-DI_summarize(blockAB_filtered)
```


```{r totals_plot}
hist(DI_summary$total, main="Total number of viable eggs per cage")
  
```

```{r DI_plot}
#plot with DI at 8 h shown as TWO DIFFERENT points (corresponding to two cabinets)
ggplot(DI_summary, aes(x=pp, y=DI, group=pop)) + geom_point() + facet_wrap(~pop)
  
```

```{r incidence_lat}
DI_short<-filter(DI_summary, pp==8)
ggplot(DI_short, aes(x=lat, y=DI, color=country)) + geom_point() + theme_bw() +stat_smooth()
```

# Calculating CPP values

5-parameter generalized log-logistic model. Explanation on page 2: http://ftp.uni-bayreuth.de/math/statlib/R/CRAN/doc/vignettes/drc/drc.pdf
d and c are upper and lower limit, respectively
e is ED50
b is relative slope aroung e
f represents asymmetry in the model; f=1 if  is symmetrical 

```{r CPP_calc_2018}
#From Kevin Emerson

# the following fits the models of the given  using data from the
# data.frame d separately for the various treatments using a 5 parameter
# logistic model
d.model.fit <- drm(DI ~ pp, data = DI_summary, curveid = pop, fct = LL.5())
#plot(d.model.fit, log = "")

# output the parameters of the model fits:
summary(d.model.fit)

# estimate the 50% intercept
ED(d.model.fit, 50)
cpp_values<-data.frame(ED(d.model.fit, 50))

```

# Recalculating CPP values for 2008 photoperiod response curves

```{r CPP_calc_2008}
DI_summary_2008<-data.frame(read.csv("CPP_2008.csv"))
d.model.fit.2008 <- drm(DI ~ photoperiod, data = DI_summary_2008, curveid = pop, fct = LL.5())
  
#plot(d.model.fit.2008, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit.2008, 50)
cpp_values_2008<-data.frame(ED(d.model.fit.2008, 50))
```
# Combine and format CPP value tables from 1988, 2008 and 2018

```{r collate_cpp_values}
cpp_2018<-data.frame(ED(d.model.fit, 50))
cpp_2018<-rownames_to_column(cpp_2018, var="pop") 
cpp_2018$pop<-str_sub(cpp_2018$pop,3,5)
popdata_2018<-DI_summary %>% group_by(pop) %>% 
  summarize(lat=first(lat), country=first(country))
cpp_2018<-right_join(cpp_2018, popdata_2018, by="pop")
cpp_2018$year<-rep("2018", nrow(cpp_2018))
colnames(cpp_2018)[colnames(cpp_2018)=="Std..Error"] <- "StdError"

cpp_2008<-data.frame(ED(d.model.fit.2008, 50)) %>% rownames_to_column(var="pop")
cpp_2008$pop<-str_sub(cpp_2008$pop,3,5)
colnames(cpp_2008)[colnames(cpp_2008)=="Std..Error"] <- "StdError"
popdata_2008<-DI_summary_2008 %>% group_by(pop) %>% 
  summarize(country=first(country), lat=first(lat), year=first(year)) 
cpp_2008<-right_join(cpp_2008, popdata_2008, by="pop")

cpp_1988<-data.frame(read.csv("CPP_1988.csv")) 
cpp_1988$pop<-na_if(cpp_1988$pop, "NA")
cpp_1988$StdError<-na_if(cpp_1988$StdError, "NA")

cpp_2<-rbind(cpp_1988, cpp_2008, cpp_2018) 
write.csv(cpp_2, "cpp_calcs_filtered.csv")

```

# CPP by latitude, country and year

```{r Japan_US_years}
ggplot(cpp_2, aes(x=lat, y=Estimate, fill=year, color=year)) + 
  scale_color_manual(values=c("white","gray","black")) + 
  scale_fill_manual(values=c("white","gray","black"))+ 
  geom_point(shape=21, color="black") + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~country) + stat_smooth(method=lm, se=FALSE)
```
```{r}
cppmodel<-lm(Estimate~lat*country*year, data=filter(cpp_2, year!=1988))
anova(cppmodel)
```


```{r }
ggplot(cpp_2, aes(x=lat, y=Estimate, color=country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~year) + stat_smooth(method=lm, se=FALSE)
```
```{r}
ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
  geom_point() +
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  stat_smooth(method=lm, se=FALSE, aes(linetype=year)) 
```

```{r incidence_lat_year}
DI_short_2008<-filter(DI_summary_2008, photoperiod==8)

#unnecessary renaming between pp/photoperiod - harmonize @ beginning?
DI_short_2018<-filter(DI_summary, pp==8) %>% group_by(pop) %>% 
  summarize(country=first(country), lat=first(lat), photoperiod=first(pp), emb=sum(emb), total=sum(total))
DI_short_2018$DI<-DI_short_2018$emb/DI_short_2018$total
DI_short_2018<-DI_short_2018[,c(1:4,7)] 
DI_short_2018$year<-rep("2018",nrow(DI_short_2018))

DI_short_2<-rbind(DI_short_2008, DI_short_2018)
write_csv(DI_short_2, "diapause_incidence_8h_2008_2018.csv")

ggplot(DI_short_2, aes(x=lat, y=DI, color=year, label=pop)) + scale_color_manual(values=c("gray","black")) + 
  geom_point() + facet_grid(~country) 

```



```{r day_function}
findDate<-function(lat, pp, year) {
#generate day lengths at latitude between July 1 and Dec 31
x<-daylength(lat,182:365)
#find position of day length in the daylength vector that is closest to photoperiod queried
daynumber<-which.min(abs(x-pp))
#convert day number to date
origin<-as.character(paste(year,"-07-01",sep=""))
return(as.character(as.Date(daynumber, origin=origin)))
}

```


```{r approx_dates, include=FALSE}
cpp_2$date<-mapply(findDate, lat=cpp_2$lat, pp=cpp_2$Estimate, year=cpp_2$year)
cpp_2$estimated_date<-format(as.Date(cpp_2$date), "%mm-%dd")
cpp_2$estimated_date<-as.Date(cpp_2$estimated_date, format="%mm-%dd")
date_plot<-ggplot(cpp_2, aes(x=lat, y=estimated_date, color=year)) + geom_point() + scale_y_date(date_breaks = "weeks" , date_minor_breaks="days", date_labels = "%b-%d") +  facet_grid(~country) + theme_bw() + stat_smooth(method=lm, se=FALSE)
```

The approximate date of 50% diapause in Berlin, NJ in 2018 was `r cpp_2[cpp_2$pop=="BER" & cpp_2$year==2018,8] %>% format("%B %d")`. 
```{r echo=FALSE}
date_plot