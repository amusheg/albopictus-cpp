
---
title: "Ae. albopictus CPP manuscript"
header-includes: #allows you to add in your own Latex packages
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
output:
  html_document: default
  word_document: default
  pdf_document: default
bibliography: MyLibrary.bib
---

```{r eval=FALSE, message=FALSE, include=FALSE}
install.packages("tidyverse") #1.2.1
install.packages("drc") #3.0.1
install.packages("stringr")
install.packages("geosphere")
install.packages("lubridate")
install.packages(c("maps", "mapdata"))
devtools::install_github("dkahle/ggmap")
install.packages("scatterpie")
install.packages("ggedit")
install.packages("ggrepel")
install.packages("papeR")
install.packages("cowplot")
install.packages("flextable")
```

```{r message=FALSE, echo=FALSE, include=FALSE}
library("papeR")
library("flextable")
library("drc") #3.0.1
library("knitr") #1.25
library("tidyverse") #1.2.1
library("stringr") #1.4.0
library("geosphere") #1.5.10
library("lubridate") #1.7.4
library("maps")
library("mapdata")
library("scatterpie")
library("ggedit")
library("ggrepel")
library("cowplot")
library("ggrepel")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi=300)
```

```{r datasheet, echo=FALSE, include=FALSE}
all_data<-data.frame(read.csv("CPP_experiment_data_collated.csv"))
#Filter out empty/discarded oviposition papers 
blockAB<-dplyr::filter(all_data, TotalLarvaeEmbryos>0)
```

```{r yields, echo=FALSE, include=FALSE}
#Calculate yield/fraction of initial count
blockAB$yield <- blockAB$TotalLarvaeEmbryos/blockAB$InitialEggs 
hist(blockAB$yield, main="Yield (final/initial count) per oviposition paper")
plot(blockAB$yield ~ blockAB$TotalLarvaeEmbryos)
```

```{r filter papers, echo=FALSE, include=FALSE}
#removing papers with <60% or >100% initial count
blockAB_unfiltered<-blockAB
blockAB_filtered <- filter(blockAB, yield<=1) %>% filter(yield>=0.6) 
```

```{r summarize, echo=FALSE, include=FALSE}
DI_summarize <- function(blockAB) {
DI_summary <- blockAB %>% 
  group_by(CageID) %>% 
  dplyr::summarise(pop=first(Population), pp=mean(Photoperiod), lat=mean(Lat), block=first(Block), country=first(Country), h1=sum(H1Count), h2=sum(H2Count), emb=sum(EmbryoCount)) %>%   filter(h1+h2+emb>100)
DI_summary$total<-DI_summary$h1+DI_summary$h2+DI_summary$emb
DI_summary$DI<-DI_summary$emb/DI_summary$total
return(DI_summary)
}
```

```{r, echo=FALSE, include=FALSE}
DI_summary<-DI_summarize(blockAB_filtered)
```

```{r totals_plot, echo=FALSE, include=FALSE}
hist(DI_summary$total, main="Total number of viable eggs per cage")
```

```{r DI_plot, echo=FALSE, include=FALSE}
#plot with DI at 8 h shown as TWO DIFFERENT points (corresponding to two cabinets)
c("PBS", "FEM", "OAK", "JAC", "BRU", "ZIO", "FAY", "NVA", "WAV", "MAN", "BER", "NEW", "OKI", "TAN", "KAG", "YAT", "SAG", "SHI", "YAM", "HIR", "KYO", "TAK", "TOK", "UTS", "KAN", "KHO", "AIZ", "NIG", "SEN", "SAK")
DI_summary$pop<-factor(DI_summary$pop, levels=c("PBS", "FEM", "OAK", "JAC", "BRU", "ZIO", "FAY", "NVA", "WAV", "MAN", "BER", "NEW", "OKI", "TAN", "KAG", "YAT", "SAG", "SHI", "YAM", "HIR", "KYO", "TAK", "TOK", "UTS", "KAN", "KHO", "AIZ", "NIG", "SEN", "SAK"))
DI_plot<-ggplot(DI_summary, aes(x=pp, y=DI, group=pop, fill=country)) + geom_point(shape=21) + facet_wrap(~fct_reorder(pop, lat)) + theme_bw() + xlab("Photoperiod (hours)") + ylab("Dipause incidence") + scale_fill_manual(values=c("black","gray")) + theme(legend.position="NULL")
```

```{r CPP_calc_2018, echo=FALSE, include=FALSE}
#From Kevin Emerson
# the following fits the models of the given  using data from the
# data.frame d separately for the various treatments using a 5 parameter
# logistic model
d.model.fit <- drm(DI ~ pp, data = DI_summary, curveid = pop, fct = LL.5())
#plot(d.model.fit, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit, 50)
cpp_values<-data.frame(ED(d.model.fit, 50))

pm<-drc:::predict.drc(d.model.fit, type="response")
```

```{r CPP_calc_2008, echo=FALSE, include=FALSE}
DI_summary_2008<-data.frame(read.csv("CPP_2008.csv"))
d.model.fit.2008 <- drm(DI ~ photoperiod, data = DI_summary_2008, curveid = pop, fct = LL.5())
  
#plot(d.model.fit.2008, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit.2008, 50)
cpp_values_2008<-data.frame(ED(d.model.fit.2008, 50))
```

```{r collate_cpp_values, echo=FALSE, include=FALSE}
cpp_2018<-data.frame(ED(d.model.fit, 50))
cpp_2018<-rownames_to_column(cpp_2018, var="pop") 
cpp_2018$pop<-str_sub(cpp_2018$pop,3,5)
popdata_2018<-DI_summary %>% group_by(pop) %>% 
  dplyr::summarize(lat=first(lat), country=first(country))
cpp_2018<-right_join(cpp_2018, popdata_2018, by="pop")
cpp_2018$year<-rep("2018", nrow(cpp_2018))
colnames(cpp_2018)[colnames(cpp_2018)=="Std..Error"] <- "StdError"
cpp_2008<-data.frame(ED(d.model.fit.2008, 50)) %>% rownames_to_column(var="pop")
cpp_2008$pop<-str_sub(cpp_2008$pop,3,5)
colnames(cpp_2008)[colnames(cpp_2008)=="Std..Error"] <- "StdError"
popdata_2008<-DI_summary_2008 %>% group_by(pop) %>% 
  dplyr::summarize(country=first(country), lat=first(lat), year=first(year)) 
cpp_2008<-right_join(cpp_2008, popdata_2008, by="pop")
cpp_1988<-data.frame(read.csv("CPP_1988.csv")) 
cpp_1988$pop<-na_if(cpp_1988$pop, "NA")
cpp_1988$StdError<-na_if(cpp_1988$StdError, "NA")
cpp_2<-rbind(cpp_1988, cpp_2008, cpp_2018) 
write.csv(cpp_2, "cpp_calcs_filtered.csv")
```

```{r Japan_US_years, echo=FALSE, include=FALSE}
cpp_japan_us_years<-ggplot(cpp_2, aes(x=lat, y=Estimate, fill=year, color=year)) + 
  scale_color_manual(values=c("white","gray","black")) + 
  scale_fill_manual(values=c("white","gray","black"))+ 
  geom_point(shape=21, color="black") + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~country) + stat_smooth(method=lm, se=FALSE)
```

```{r cppmodel, echo=FALSE, include=FALSE}
cppmodel<-lm(Estimate~lat*country*year, data=filter(cpp_2, year!=1988))
cppmodel_result<-data.frame(anova(cppmodel))
```

```{r, echo=FALSE, include=FALSE}
ggplot(cpp_2, aes(x=lat, y=Estimate, color=country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~year) + stat_smooth(method=lm, se=FALSE)
```

```{r, echo=FALSE, include=FALSE}
cpp_08_18_shifts<-ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
  geom_point(size=3) + scale_color_manual(values=c("red", "blue")) +
  stat_smooth(method=lm, se=FALSE, aes(linetype=year)) + scale_linetype_manual(values=c("dotted","solid")) + theme_bw() + theme(legend.position=c(.8,.25)) + xlab("Latitude") + ylab("Critical photoperiod")
  # + geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) 

cpp_08_18_shifts_bw<-ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, fill=country, shape=year)) + 
  geom_point(size=3) + scale_fill_manual(values=c("black", "gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Year") +
  stat_smooth(method=lm, se=FALSE, aes(linetype=year, color=country)) + scale_linetype_manual(values=c("dotted","solid"), name="Year") + 
  scale_color_manual(values=c("black","gray"), name="Country") +
  guides(fill=guide_legend(override.aes=list(shape=22)), linetype=guide_legend(override.aes=list(color="black")),
  color=guide_legend(override.aes=list(linetype=0)), color=guide_legend(override.aes=list(linetype=0)), linetype=guide_legend(legend.key.width=unit(3,"line"))) +
  theme_bw() + theme(legend.position=c(.8,.25), text=element_text(size=12)) + xlab("Latitude") + ylab("Critical photoperiod (h)")
```

```{r incidence_lat_year, echo=FALSE, include=FALSE}
DI_short_2008<-filter(DI_summary_2008, photoperiod==8)
DI_short_2018<-filter(DI_summary, pp==8) %>% group_by(pop) %>% 
  dplyr::summarize(country=first(country), lat=first(lat), photoperiod=first(pp), emb=sum(emb), total=sum(total))
DI_short_2018$DI<-DI_short_2018$emb/DI_short_2018$total
DI_short_2018<-DI_short_2018[,c(1:4,7)] 
DI_short_2018$year<-rep("2018",nrow(DI_short_2018))
DI_short_2<-rbind(DI_short_2008, DI_short_2018)
write_csv(DI_short_2, "diapause_incidence_8h_2008_2018.csv")
```

```{r dimodel, echo=FALSE, include=FALSE}
dimodel<-lm(DI~lat*country*year, data=DI_short_2)
dimodel_result<-data.frame(anova(dimodel))
#checking for normality of residuals
dimodel.stdres<-rstandard(dimodel)
qqnorm(dimodel.stdres, ylab="Standardized Residuals", xlab="Normal Scores", main="Normal Probability Plot")
qqline(dimodel.stdres)
```

```{r maps, echo=FALSE, include=FALSE}
usa<-map_data("usa")
jp<-map_data("japan")
pops<-data.frame(read.csv("mapping_pops_cpp_expt.csv"))
us_map<-ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group=group), fill=NA, color="blue") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="US"), aes(x = longitude, y = latitude), size = 1) + xlim(c(-85, -65)) +
  geom_label(data=filter(pops, country=="US"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() 
japan_map<-ggplot() + geom_polygon(data = jp, aes(x=long, y = lat, group=group), fill=NA, color="red") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="JP", only_2008=="n"), aes(x = longitude, y = latitude), size = 1)  + xlim(c(125, 147)) +
  geom_label_repel(data=filter(pops, country=="JP", only_2008=="n"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() + theme(axis.title.x=element_blank(), axis.title.y=element_blank())
DI_data<-data.frame(read.csv("diapause_incidence_8h_2008_2018.csv"))
DI_data$ND<-1-DI_data$DI
DI_info<-full_join(DI_data, pops)
DI_info<-rename(DI_info, Diapause=DI, Nondiapause=ND)
us_DI_pies<-remove_geom(us_map, "label") + geom_scatterpie(data=filter(DI_info, country=="US"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())
jp_DI_pies<-remove_geom(japan_map, "label") + geom_scatterpie(data=filter(DI_info, country=="JP"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + 
  facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())
DI_pies_2018<-plot_grid(remove_geom(us_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="US", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")), 
                        
remove_geom(japan_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="JP", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")), ncol=2, align="hv")


#bw locations map
us_map_bw<-ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group=group), fill=NA, color="black") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="US"), aes(x = longitude, y = latitude), size = 2) + xlim(c(-87, -65)) + ylim(c(24,48)) +
  geom_label_repel(data=filter(pops, country=="US"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines"), nudge_x=1.5) + theme_bw() + xlab("") + ylab("")

japan_map_bw<-ggplot() + geom_polygon(data = jp, aes(x=long, y = lat, group=group), fill=NA, color="black") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="JP", only_2008=="n"), aes(x = longitude, y = latitude), size = 2)  + xlim(c(125, 147)) + ylim(c(24,48)) +
  geom_label_repel(data=filter(pops, country=="JP", only_2008=="n"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines"), nudge=-4) + theme_bw()  + xlab("") + ylab("Latitude")

map_panels_bw<-plot_grid(japan_map_bw, us_map_bw)
```

```{r, echo=FALSE, include=FALSE}
#GDD deadline data
#importing and reshaping table
gdd400_us <- read.csv("GDD400_US.csv", check.names=FALSE) %>% gather(year, gdd400, "1998":"2018", factor_key=FALSE)
gdd400_us$year<-as.numeric(gdd400_us$year)
gdd400_jp <- read.csv("GDD400_JP.csv", check.names=FALSE) %>% gather(year, gdd400, "1998":"2018", factor_key=FALSE)
gdd400_jp$year<-as.numeric(gdd400_jp$year)
#adding latitudes
locations<-read.csv("mapping_pops_cpp_expt.csv")
gdd400_us<-left_join(gdd400_us, dplyr::select(locations, pop, latitude, country, only_2008), by=c("pop"))
gdd400_jp<-left_join(gdd400_jp, dplyr::select(locations, pop, latitude, country, only_2008), by=c("pop"))
gdd400_all<-rbind(gdd400_us, gdd400_jp)
gdd400_all$pop<-as.factor(gdd400_all$pop)
gdd400_all<-mutate(gdd400_all, interval=case_when(year<=2017 & year>=2008 ~ 'y2008-2017',
                                                  year<2008 ~ 'y1998-2007'))
```

```{r, echo=FALSE, include=FALSE}
#GDD deadline data
#importing and reshaping table
gdd465_us <- read.csv("GDD465_US.csv", check.names=FALSE) %>% gather(year, gdd465, "1998":"2018", factor_key=FALSE)
gdd465_us$year<-as.numeric(gdd465_us$year)
gdd465_jp <- read.csv("GDD465_JP.csv", check.names=FALSE) %>% gather(year, gdd465, "1998":"2018", factor_key=FALSE)
gdd465_jp$year<-as.numeric(gdd465_jp$year)
gdd465_all<-rbind(gdd465_us, gdd465_jp)
gdd465_all$pop<-as.factor(gdd465_all$pop)
gdd_all<-left_join(gdd400_all, gdd465_all)
gdd_all$gdd<-(gdd_all$gdd400 + gdd_all$gdd465)/2
```

```{r, echo=FALSE, include=FALSE}
gdd_deadline_plots<-ggplot(filter(gdd400_all, only_2008=="n", year!=2018), aes(x=latitude, y=gdd400, fill=country)) + scale_fill_manual(values=c("black", "gray"), name="Country") + geom_point(shape=21) + facet_wrap(~year) + xlab("Latitude") + ylab("GDD Deadline (ordinal day)") + theme_bw() + theme(legend.position="bottom")

```

```{r echo=FALSE, include=FALSE}
#adding 2008 and 2018 CPP values 
cpp_year<-dplyr::select(read.csv("cpp_calcs_filtered.csv"), pop, Estimate, year) %>% filter(year!="1988") %>% rename("CPP_YEAR"="year")
gdd400_all_new<-left_join(gdd400_all, cpp_year, by=c("pop"))
gdd400_all_new$CPP_YEAR<-as.factor(gdd400_all_new$CPP_YEAR)

gdd_all_new<-left_join(gdd_all, cpp_year, by="pop")
gdd_all_new$CPP_YEAR<-as.factor(gdd_all_new$CPP_YEAR)


```

```{r echo=FALSE, include=FALSE}
#GDD deadlines averaged across all years
gdd_summaries<-gdd_all_new %>% filter(interval!="NA") %>% group_by(pop) %>% dplyr::summarise(gdd400_mean=mean(gdd400), gdd400_sd=sd(gdd400), gdd465_mean=mean(gdd465), gdd465_sd=sd(gdd465), latitude=mean(latitude), country=first(country), only_2008=first(only_2008))

lat_gdd_average<-ggplot(filter(gdd_summaries, only_2008=="n"), aes(x=latitude, y=gdd400_mean, fill=country)) + geom_point(shape=21) + scale_fill_manual(values=c("black", "gray")) + geom_errorbar(aes(ymin=gdd400_mean-gdd400_sd, ymax=gdd400_mean+gdd400_sd, color=country)) + scale_color_manual(values=c("black","gray")) + theme_bw() + theme(legend.position="bottom") + xlab("Latitude (N)") + ylab("GDD Deadline (ordinal day)")

```

```{r echo=FALSE, include=FALSE}
#plotting GDD deadlines and CPP
gdd_08 <- ggplot(filter(gdd400_all_new, year==2007, CPP_YEAR==2008), aes(x=gdd400, y=Estimate, fill=country)) + scale_fill_manual(values=c("black","gray"), name="Country") + geom_point(size=3, shape=21) + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black","gray"), name="Country") +
  theme_bw() + theme(legend.position="none", text=element_text(size=12)) +
  xlab("GDD Deadline (ordinal day), 2007") + ylab("Critical photoperiod (h), 2008") + ylim(12.3,14.2)

gdd_18 <- ggplot(filter(gdd400_all_new, year==2017, CPP_YEAR==2018), aes(x=gdd400, y=Estimate, fill=country)) + scale_fill_manual(values=c("black","gray"), name="Country") + geom_point(size=3, shape=21) + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black","gray"), name="Country") +
theme_bw() + theme(legend.position=c(.8,.8), text=element_text(size=12)) +
xlab("GDD Deadline (ordinal day), 2017") + ylab("Critical photoperiod (h), 2018") + ylim(12.3, 14.2)

```

```{r echo=FALSE, include=FALSE}
#plotting CPP by GDD deadlines averaged over intervals
interval_summaries<-gdd_all_new %>% filter(interval!="NA") %>% group_by(pop, interval, CPP_YEAR) %>% dplyr::summarise(gdd400_mean=mean(gdd400), gdd400_sd=sd(gdd400), cpp=mean(Estimate), latitude=mean(latitude), country=first(country), only_2008=first(only_2008))

gdd_cpp_interval_18<-ggplot(filter(interval_summaries, interval=="y2008-2017", CPP_YEAR==2018), aes(x=gdd400_mean, y=cpp, fill=country)) + geom_point(size=3, shape=21) + scale_fill_manual(values=c("black","gray"), name="Country") + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black", "gray"), name="Country") + theme_bw() + theme(legend.position="none", text=element_text(size=12)) + xlab("Mean GDD deadline, 2008-2017 (ordinal day)") + ylab("Critical photoperiod, 2018 (h)") + ylim(12.3, 14.2)

gdd_cpp_interval_08<-ggplot(filter(interval_summaries, interval=="y1998-2007", CPP_YEAR==2008), aes(x=gdd400_mean, y=cpp, fill=country)) + geom_point(size=3, shape=21) + scale_fill_manual(values=c("black","gray"), name="Country") + stat_smooth(method=lm, se=FALSE, aes(color=country)) + scale_color_manual(values=c("black", "gray"), name="Country") + theme_bw() + theme(legend.position="none", text=element_text(size=12)) + xlab("Mean GDD deadline, 1998-2007 (ordinal day)") + ylab("Critical photoperiod, 2008 (h)") + ylim(12.3, 14.2)

```

```{r echo=FALSE, include=FALSE}
gdd_cpp_plot<-plot_grid(gdd_08, gdd_18, gdd_cpp_interval_08, gdd_cpp_interval_18, nrow=2, labels="AUTO")

```


```{r echo=FALSE, include=FALSE}
#2015 Diapause Incidence Field Trial
field_data<-read.csv("DI_2015_FIELD.csv")
field_data$WeekDate <- reorder(field_data$WeekDate, field_data$Week)
field_data_plot<-ggplot(filter(field_data, Eggs=="Field"), aes(x=WeekDate, y=DI)) + geom_point(size=3, shape=21, fill="gray") + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
xlab("Week") + ylab("Diapause incidence") + geom_vline(aes(xintercept=10.4), linetype="dotted")

field.model.fit <- drm(DI ~ Week, data = filter(field_data, Eggs=="Field"), fct = LL.5())
summary(field.model.fit)
# estimate the 50% intercept
cpp_field<-data.frame(ED(field.model.fit, 50))

```


```{r echo=FALSE, include=FALSE}
data_18<-gdd400_all_new %>% filter(CPP_YEAR==2018) %>% filter(year==2017)
model1<-lm(Estimate~gdd400*country, data=data_18)

data_08<-gdd400_all_new %>% filter(CPP_YEAR==2008) %>% filter(year==2007)
model2<-lm(Estimate~gdd400*country, data=data_08)

model3<-lm(cpp~gdd400_mean*country, data=filter(interval_summaries, interval=="y2008-2017", CPP_YEAR==2018))
model4<-lm(cpp~gdd400_mean*country, data=filter(interval_summaries, interval=="y1998-2007", CPP_YEAR==2008))

anova(model1)
anova(model2)
anova(model3)
anova(model4)

```

```{r echo=FALSE, include=FALSE}
write.csv(filter(gdd400_all_new, year %in% c(2007,2017)), "gdd_cpp_07_17.csv")
prev_year<-read.csv("gdd_prevyear.csv")
prev_year$CPP_YEAR<-as.factor(prev_year$CPP_YEAR)

write.csv(interval_summaries, "interval_summaries.csv")
prev_interval<-read.csv("gdd_previnterval.csv")
prev_interval$CPP_YEAR<-as.factor(prev_interval$CPP_YEAR)

```

```{r echo=FALSE, include=FALSE}
prevyear_all<-ggplot(prev_year, aes(x=prev_year_gdd400, y=Estimate, fill=country, shape=CPP_YEAR)) + 
  geom_point(size=3) + scale_fill_manual(values=c("black", "gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Year") +
  stat_smooth(method=lm, se=FALSE, aes(linetype=CPP_YEAR, color=country)) + scale_linetype_manual(values=c("dotted","solid"), name="Year") + 
  scale_color_manual(values=c("black","gray"), name="Country") +
  guides(fill=guide_legend(override.aes=list(shape=22)), linetype=guide_legend(override.aes=list(color="black")),
  color=guide_legend(override.aes=list(linetype=0)), color=guide_legend(override.aes=list(linetype=0)), linetype=guide_legend(legend.key.width=unit(3,"line"))) +
  theme_bw() + theme(legend.position="none", text=element_text(size=12)) + xlab("Previous year's GDD deadline (ordinal day)") + ylab("Critical photoperiod (h)") + ylim(12.3,14.2)

previnterval_all<-ggplot(prev_interval, aes(x=gdd400_mean_previnterval, y=cpp, fill=country, shape=CPP_YEAR)) + 
  geom_point(size=3) + scale_fill_manual(values=c("black", "gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Year") +
  stat_smooth(method=lm, se=FALSE, aes(linetype=CPP_YEAR, color=country)) + scale_linetype_manual(values=c("dotted","solid"), name="Year") + 
  scale_color_manual(values=c("black","gray"), name="Country") +
  guides(fill=guide_legend(override.aes=list(shape=22)), linetype=guide_legend(override.aes=list(color="black")),
  color=guide_legend(override.aes=list(linetype=0)), color=guide_legend(override.aes=list(linetype=0)), linetype=guide_legend(legend.key.width=unit(3,"line"))) +
  theme_bw() + theme(legend.position=c(.8,.75), text=element_text(size=12)) + xlab("Previous decade's GDD deadline (ordinal day)") + ylab("Critical photoperiod (h)") + ylim(12.3,14.2)

prev_year_plots<-plot_grid(prevyear_all, previnterval_all, labels="AUTO")
```

```{r echo=FALSE, include=FALSE}
all_prevyear_model<-lm(Estimate~prev_year_gdd400*country*CPP_YEAR, data=prev_year)
all_previnterval_model<-lm(cpp~gdd400_mean_previnterval*country*CPP_YEAR, data=prev_interval)
```

## Introduction

- Diapause is an important overwintering adaptation in many organisms
- Photoperiod provides a reliable signal of time of year and so is used by many organisms to regulate seasonal strategies
- The optimal time of year to go into diapause might depend on a lot of different climactic factors and fitness considerations
- Climate change may have unpredictable effects on growing seasons
- Invasive species provide natural experiments for rapid adaptation
- Aedes albopictus worldwide spread: diapause played a role 
- What is the continuing role of diapause in light of environmental change, continuing introductions, competing selective pressures? 
- We recapitulated 2008 CPP study using the same experimental design and methods

## Methods

### Mosquito population sampling and pre-experiment colony maintenance
Mosquito populations were sampled as larvae and pupae in the eastern USA and Japan in June-September 2018, at latitudes ranging from `r min(pops$latitude)` to `r max(pops$latitude)`. Sampling locations are described in Table 1. Locations in the US were identical to locations sampled in 2008. Japanese population samples were confirmed to be Ae. albopictus via morphological identification following [@tanakaRevisionAdultLarval1979] and sent to Georgetown as F1 or F2 eggs. At least 50 male and 50 female adult mosquitoes were used to initiate all populations in the laboratory at Georgetown, except for SEN, which had 37 females and 39 males.  

```{r echo=FALSE}
map_panels_bw

```


```{r table1, echo=FALSE}
kable(filter(pops, only_2008=="n")[,1:6], col.names=c("Population", "City", "Latitude", "Longitude", "Country", "Life Stage Sampled"), caption="Table 1: 2018 Sampling Locations")
```

Populations were maintained in the laboratory for 3 or 4 generations prior to the experiment at 21C and 80% relative humidity under a 16:8h light:dark cycle, following previous studies [@armbrusterGeographicVariationLarval2006; @urbanskiRapidAdaptiveEvolution2012]. Larvae were reared in distilled water and fed a slurry of dog food and brine shrimp. Adults were provided organic raisins as a carbohydrate source and blood meals from a human host. Initial laboratory generations of larvae were reared in plastic storage containers containing ~2.5 L of distilled water, with one population per container at initial densities of ~200-300, for ease of bulk rearing. Pupae were then transferred into one adult cage per population. Populations generally had at least 50 female and 50 male adults per generation, but the JAC population experienced visibly high mortality during the F2 generation. The larval generation immediately prior to the experiment was reared in 15 cm plastic petri dishes containing 30-40 larvae each, 10 dishes per population, to match the larval rearing conditions of the experimental generation, which followed the methods of Urbanski et al 2012. Additional details of mosquito husbandry prior to the experiment can be found in Supplementary File 1. 

### Critical photoperiod determination
An overview of the procedure used to determine the critical photoperiod (CPP) is as follows: Starting from the pupal stage, mosquitoes were divided among 12 different photoperiods (listed in Supplementary File 1) and allowed to produce eggs. The proportion of diapause eggs at each photoperiod was determined, and a dose-response curve was constructed with respect to hours of light and proportion of eggs in diapause. The critical photoperiod was calculated as the number of hours of light at which 50% of the eggs produced were in diapause, excluding the fraction of constitutively non-diapausing eggs (i.e. the fraction that did not enter diapause under unambigous short-day conditions, 8 hours of light). This experimental design and most of the equipment and experimental details were the same as those used in Urbanski et al 2012; additional details on all steps can be found in Supplementary File 1. 

Due to the large number of populations and photoperiods, the experiment was conducted in two blocks. Each block contained half of the populations from each country; populations across the full range of latitudes from each country were interspersed between the blocks. At the beginning of each block, eggs were hatched by submerging oviposition papers in distilled water with larval food for two days. Larvae were distributed among 40 15 cm petri dishes containing 90 ml of a mixture of distilled water and larval food (5 L of water to 10 mL of food slurry) at a density of 30-40 larvae per dish. Larvae were transferred to clean dishes containing fresh water/food mixture every Monday-Wednesday-Friday (MWF) until pupation. Larvae were kept in the controlled temperature room at 21C, 80% humidity and 16:8 hours light:dark until they produced pupae.

Pupae from each population were collected, pooled across dishes, and split amongst thirteen 1.5 L adult cages, corresponding to twelve photoperiod cabinets and an additional short-day (8h light) incubator to provide additional data on unambiguous short-day diapause incidence. The total number of pupae added to each cage ranged from 52 to 106; pupae were not sexed and subsequent pupal and adult mortality was not monitored. Approximately one week after the last pupae were added, cages were offered a blood meal, and a dark oviposition cup half-filled with water and lined with unbleached paper towel was added to each cage. Oviposition papers were collected 5-7 days after the blood meal and replaced every MWF; a total of four oviposition papers were collected from each cage. Several cages were fed again and an additional oviposition paper was collected; see supplemental methods for details. Oviposition papers were dried gently and stored in the photoperiod cabinets from which they originated for 11 to 21 days until diapause determination. 

On each oviposition paper, eggs were counted (subsampling if oviposition was very high; see supplemental methods) and papers were submerged in distilled water with ~0.25 ml larval food. Larvae that hatched were counted two days later and papers were re-dried and stored as before. After 1-2 weeks, hatch was induced again and larvae were counted. Oviposition papers were then treated overnight with a bleach solution to clear the chorion of the remaining eggs [@trpisNewBleachingDecalcifying1970] . Eggs were examined under a stereomicroscope, and those eggs containing a pharate larva were scored as embryonated and in diapause. The total number of hatched larvae and embryonated eggs was considered the number of viable eggs. Oviposition papers in which viable eggs made up less than 60% or more than 100% of the eggs initially counted on the paper were excluded from further analysis. Analysis dates, subsampling and other detailed information about each oviposition paper can be found in Data Table 1.

For each cage, the counts of larvae and embryos across all oviposition papers were pooled to calculate the diapause incidence, or the fraction of total viable eggs that are in diapause (# embryonated / (# embryonated + # hatched)). The median total number of viable eggs per cage was `r median(DI_summary$total)` (range `r min(DI_summary$total)`-`r max(DI_summary$total)`). For the 8-hour photoperiod, each population had data from two cages: one in a photoperiod cabinet and one in a separate incubator. These data were pooled to calculate the value for diapause incidence at unambiguous short-day (DI) for the population, but used as separate data points in photoperiod response curves. 

Photoperiod response data from 2008 were obtained from the data files of Urbanski et al 2012 (doi:10.5061/dryad.68277435).

### Climate data and growing degree day calculations
Daily maximum and minimum temperatures for each location were obtained from the Climate Prediction Center of the National Oceanic and Atmospheric Administration (CPC NOAA, https://www.esrl.noaa.gov/psd/). These observations are available at 0.5º spatial and daily temporal resolution. Data were missing in the CPC dataset for three locations in Japan (Okinawa, Tanegashima, and Shimonoseki); for these we used the European Center’s Medium Range Weather Forecasting/ ERAI reanalysis [@deeERAInterimReanalysisConfiguration2011]. This reanalysis is available at 0.125º resolution from 1979 – present. 

These temperatures were to calculate daily GDD values, with minimum and maximum thresholds of 11º C and 33º C, respectively, as described in [@baskervilleRapidEstimationHeat1969]. For each year, daily GDD values were accumulated backward beginning from 31 December. We then extracted the day of the year when 400 or 465 GDD is reached to obtain the deadline date.  


### Statistical analysis
Critical photoperiod was calculated from photoperiod response curves (Figure S1) as ED50 using a five-parameter generalized log-logistic model in the R (3.6.0) package drc (`r packageVersion("drc")`). Effects of latitude, country and year (2008 vs. 2018) on CPP and on DI were analyzed with linear models. Data manipulation and figure construction were carried out using packages in tidyverse (`r packageVersion("tidyverse")`).

## Results and Discussion (mostly Results)

Latitude-specific DI (the fraction of diapausing eggs produced under unambiguous short-day conditions) did not significantly differ between 2008 and 2018 in Japan or the US (p=0.94, Figure 2, Table 2).  DI was high (generally greater than 90%) at latitudes north of ~32.5 degrees in both countries. Substantial fractions of constitutively non-diapausing eggs were observed in populations south of South Carolina in the US and in Okinawa in Japan (latitude p=<0.001). Latitude-specific DI was lower in the US than in Japan (country p=0.026), though there were fewer sites sampled at lower latitudes in Japan than the US due to lack of land between Okinawa and Kagashima. 

[To discuss: could it be that the steep gradient in diapause incidence over a relatively small geographic scale in Florida suggests that it's the result of a gradient of admixture from tropical populations rather than an adaptive gradient?]

```{r fig.cap="Figure 2B: Diapause incidence by country and year. Lines represent locally estimated scatterplot smoothing (LOESS). Solid lines, 2018 data; dotted lines, 2008 data.", echo=FALSE, message=FALSE}
#country_DI

country_DI_color<-ggplot(filter(DI_short_2, year!=1988), aes(x=lat, y=DI, color=country, shape=year)) + scale_color_manual(values=c("red","blue")) + geom_point(size=3) + theme_bw() + theme(legend.position=c(0.9,0.3)) + stat_smooth(aes(linetype=year), se=FALSE) + scale_linetype_manual(values=c("dotted","solid")) + xlab("Latitude") + ylab("Short-day diapause incidence")

country_DI_bw<-ggplot(filter(DI_short_2, year!=1988), aes(x=lat, y=DI, fill=country, shape=year)) + scale_fill_manual(values=c("black","gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Year") + geom_point(size=3) + theme_bw() + theme(legend.position=c(0.9,0.3), text=element_text(size=12)) + guides(fill = guide_legend(override.aes=list(shape=22))) + xlab("Latitude") + ylab("Short-day diapause incidence") + stat_smooth(aes(linetype=year, color=country), se=FALSE) + scale_linetype_manual(values=c("dotted","solid"), name="Year") + scale_color_manual(values=c("black","gray"), name="Country")

country_DI_bw
```
```{r echo=FALSE, warning=FALSE}
ggplot(filter(DI_short_2, year!=1988), aes(x=lat, y=DI, fill=country, shape=year)) + scale_fill_manual(values=c("black","gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Year") + geom_point(size=3) + theme_bw() + theme(legend.position=c(0.9,0.3), text=element_text(size=12)) + guides(fill = guide_legend(override.aes=list(shape=22))) + xlab("Latitude") + ylab("Short-day diapause incidence") + geom_smooth(aes(linetype=year, color=country), se=FALSE, method="glm", method.args=list(family="binomial")) + scale_linetype_manual(values=c("dotted","solid"), name="Year") + scale_color_manual(values=c("black","gray"), name="Country")

```

```{r echo=FALSE}
kable(prettify(anova(dimodel)), digits=3, caption="Table 2: Effects of latitude, country and year (2008 vs 2018) on diapause incidence.")
```

We next examined critical photoperiod among the diapausing fraction of each population. CPP values correlated strongly with latitude in the US and Japan (p<0.001, Table 3). Latitudinal clines were nearly parallel to those observed in 2008 (Figure 3), as verified by the lack of a significant interaction term between year and latitude (p=0.17). However, the intercepts of the latitudinal clines significantly differed between both the US and Japan, and between 2008 and 2018 (p<0.001 for both country and year). Latitude-specific CPP was higher in Japan than the US, and higher in 2018 compared to 2008. This implies earlier entry into diapause at the same latitude in Japan than in the US, as well as earlier entry into diapause in the same locations in 2018 than in 2008. Both of these differences are contrary to expectations based on global warming trends and the consistently milder winters in Japan compared to US.



```{r fig.cap="Figure : Shifts in critical photoperiod latitudinal clines. Lines represent linear regressions. Solid lines, 2018; dotted lines, 2008.", echo=FALSE}
cpp_08_18_shifts_bw
```

```{r table3, echo=FALSE}
kable(prettify(anova(cppmodel)), digits=3, caption="Table 3: Effects of latitude, country and year on critical photoperiod in 2008 and 2018.")
```

We reasoned that the optimal time for entering diapause depended on the amount of time required to complete a full generation under particular climatic conditions. Insect phenology studies often estimate generation times using growing degree day (GDD) models, which take advantage of the fact that insect development time is linearly temperature-dependent under moderate climate conditions. Based on a survey of literature of Aedes albopictus growth rates under various temperature conditions, we estimated that a mosquito generation - from the egg stage through ovipostion - required 400-465 growing degree-days. We used climate records over the past 20 years from our sampling locations to calculate a yearly GDD-based "deadline" for diapause at each location: the date after which eggs laid would not have enough growing degree days left in the year to complete another generation. 

Although field data about Aedes albopictus diapause egg production are scarce, we were able to use field observations collected in 2015 at site in Washington, DC, USA as preliminary verification of the GDD approach. Briefly, oviposition cups were placed outdoors and Aedes albopictus eggs collected weekly were scored for diapause incidence using the same methods described here. The diapause incidence curve (Fig S) was used to determine the critical date at which the majority of eggs produced by wild mosquitoes were in diapause. The critical date occurred during the week of September 7, 2015, corresponding to ordinal day 250. The calculated deadline for Manassas, VA (~50 km from DC) in 2015 was 256-263. In 2014, the calculated deadline was 247-252. These results confirmed that GDD deadlines broadly correspond to field observations and suggested that examining the GDD deadline in years preceding the collection year is a reasonable approach.

GDD deadlines calculated using historical climate data correlated with latitude, as expected. The latitude-specific GDD deadline was earlier in Japan in the US for most years examined (Figure SX), indicating that although the Japanese locations generally experienced a later date of first frost, the limits of the growing seasons in the two regions may be better captured by measures such as GDD that take into account the distribution of temperature conditions over the season. 

We examined the relationship between critical photoperiod and two GDD deadline values for each population: the 400 GDD deadline in the year immediately preceding the 2008 and 2018 studies, and the mean 400 GDD deadline over the preceding 10-year interval. [NB: 2008 populations were actually collected over the period 2005-2008...] These four correlations (2008 CPP vs 2007 GDD deadline; 2008 CPP vs 1998-2007 mean deadline; 2018 CPP vs 2017 deadline; and 2018 CPP vs. 2008-2017 mean deadline) were analyzed independently. In all four models, the country effect was not significant, suggesting that GDD deadlines predicted critical photoperiods across countries. There was also a significant GDD deadline by country interaction effect in the model in which 2017 deadline was used as an explanatory variable for 2018 CPP data, but not when the GDD deadline was averaged over the preceding 10 years, suggesting that year-to-year variation may additionally affect the relationship between local GDD conditions and local CPP. 

```{r echo=FALSE}
gdd_cpp_plot
```




```{r echo=FALSE}
kable(rbind(prettify(anova(model2)), prettify(anova(model1)), prettify(anova(model4)), prettify(anova(model3))), digits=3)  
```


```{r echo=FALSE}
prev_year_plots
```

```{r echo=FALSE}
kable(prettify(anova(all_prevyear_model)), digits=3) 
kable(prettify(anova(all_previnterval_model)), digits=3)

```


The GDD-based estimate of diapause deadline date does not explain the shift to earlier critical photoperiod between 2008 and 2018. Although deadline dates vary from year to year, there is no discernible directional trend over the 20-year period examined, except for very slight trends 

We cannot exclude the possibility that the temporal shift in CPP between the 2008 and 2018 studies was due to experimental variability. For example, some of the populations in the 2008 study had been maintained in the laboratory for up to 14 generations, whereas in the current experiment they were reared for 3-4 laboratory generations; it is unknown how quickly acclimation or adaptation to laboratory conditions occurs in this species. In addition, there were likely cryptic differences in laboratory rearing conditions between 2008 and 2018, as evidenced by the fact that in the 2008 study more cages required multiple blood meals to produce sufficient eggs for analysis, hinting at higher mortality, lower fecundity, or both. 

## Supplementary File 1

## Supplementary methods

### Larval rearing
Larvae were fed a slurry of 40 g frozen brine shrimp (San Francisco Bay Brand) and 120 g dog food (Nutro Feed Clean Ultra Small Breed Puppy formula) homogenized in 1 L of distilled water. Larvae were initially raised in plastic storage containers (Sterilite) containing 2.5 L of distilled water. Every Monday-Wednesday-Friday (MWF), the water in each container was removed by straining through a net and replaced with fresh distilled water; each container was fed approximately 1.5 ml of larval food slurry. Containers were covered with a fine mesh and kept at 21C, 80% humidity, and 16:8 L:D photoperiod. Starting with the generation prior to the one used in the experiment, larvae were reared in 15 cm petri dishes (Kord-Valmark), as in Urbanski et al 2012. The pre-experiment generation was fed ~0.5-0.6 ml larval food per dish, while the experimental generation had food/water concentrations as described in the main manuscript. Every MWF, larvae were transferred to clean petri dishes with a pipette and had fresh food/water added. When removing pupae substantially reduced the density of larvae, the remaining larvae were consolidated into fewer dishes. 

### Photoperiod cabinets 
The custom-built photoperiod cabinets were the same ones used in Urbanski et al 2012, described in detail in the Appendix (https://www.journals.uchicago.edu/doi/suppl/10.1086/664709/suppl_file/53244apa.pdf). The light-dark cycles used were 8L : 16D, 12L : 12D, 12.5L : 11.5D, 12.75L : 11.25D, 13L : 11D, 13.25L : 10.75D, 13.5L : 10.5D, 13.75L : 10.25D, 14L : 10D, 14.25L : 9.75D, 14.5L : 9.5D, and 16L : 8D. Light and temperature inside cabinets were recorded for at least three full days for each cabinet in each block. The highest recorded temperature in any cabinet at any point was 22.65C, the lowest was 20.72C, and 70% of temperature readings were between 21C and 22C. All light:dark cycles were within 1 minute of desired photoperiod except for the separate short-day incubator (Cabinet 13 in Data Table 1), which was within 5 minutes of 8 hours of light (7:59 -8:05). Cages in photoperiod cabinets were monitored daily for desiccation and mold; water was added to cages and raisins were replaced as needed. 

### Blood meals, egg collection and storage
Adult cages were fed from a human host over a three-day period; feeding days were randomly assigned by photoperiod cabinet. Collected oviposition papers were stored in 10 cm petri dishes inside humidified containers in the photoperiod cabinet in which they originated. In the second block of the experiment, two cages produced less than 200 eggs after the initial blood meal, and the cages in the cabinets with 14.5 hours and 14.25 hours of light had large numbers of larvae that hatched on the wet oviposition paper on the first egg collection day due to incomplete drying and thus could not be accurately counted. These 24 cages were offered a second blood meal and an additional oviposition paper was collected a week later. Papers with eggs produced after a second blood meal have a Paper ID ending in “-5” in Data Table 1.

### Diapause determination
Oviposition papers were trimmed to a ~2 cm strip surrounding the former location of the waterline in the oviposition cup; this zone generally contained the vast majority of the eggs. On oviposition papers with few eggs, the paper was trimmed in such a way as to capture all of them. On papers with very dense oviposition, the egg-containing strip was haphazardly subsampled further, to several hundred eggs as approximated by eye.

After eggs were bleached, presence of pharate larvae was determined using the diagnostic criteria of visible eye spots and abdominal segmentation. On some oviposition papers, larvae “hatched” out of the eggs after the bleach solution was added; these were scored as embryonated diapause eggs because they appeared to be morphologically normal and did not hatch when induced with standard hatching cues twice. 

The total number of hatched larvae and embryos could differ from the number of eggs initially counted on the paper for the following reasons: 1) presence of inviable eggs or larvae (i.e., eggs that fail to hatch due to developmental abnormalities or larvae that die before being counted), 2) loss of eggs while handling oviposition papers, or 3) inaccurate counting at any step of the scoring process. Based on the distribution of percent differences from the initial counts (Figure S1A), we considered oviposition papers with more than 100% or less than 60% of the initial count to be less reliable data points; these papers made up less than 10% of both individual papers and total eggs quantified in the experiment. Excluding these data points resulted in 5 cages out of 286 in the total data set (1.7%) having less than 100 remaining eggs, so they were excluded from the photoperiod response curves. These filtering steps and exclusions did not affect CPP estimates for any population except PBS; for this population, excluding the unreliable counts eliminated an outlier in the photoperiod response curve and brought the CPP estimate into the range of CPP values for the rest of the populations (Figure S2). The final photoperiod response curves are shown in Figure S3.

```{r, echo=FALSE}
yield_plot<-ggplot(blockAB, aes(x=TotalLarvaeEmbryos, y=yield)) + geom_point(alpha=0.5) + xlab("Number of viable eggs on oviposition paper") + ylab("Viable eggs/initial egg count on paper") + theme_bw()

#comparing CPP values calculated with and without filtering out unreliable oviposition papers
cpp_filtered<-read.csv("cpp_calcs_filtered.csv") %>% filter(year==2018)
cpp_unfiltered<-read.csv("cpp_calcs_unfiltered.csv") %>% filter(year==2018)
names(cpp_filtered)[5]<-"CPP_est_filt"
names(cpp_unfiltered)[5]<-"CPP_est_unfilt"
cpp_compare<-left_join(cpp_filtered,cpp_unfiltered,by="pop")
filter_compare_plot<-ggplot(cpp_compare, aes(x=CPP_est_unfilt, y=CPP_est_filt)) + geom_point() + geom_abline(slope=1, intercept=0) + xlab("CPP without filtering criteria") + ylab("CPP calculated with filtering criteria") + theme_bw()
```

```{r, echo=FALSE}
quality_control_fig<-plot_grid(yield_plot, filter_compare_plot, labels="AUTO")
quality_control_fig
```


```{r, echo=FALSE}
DI_plot 
```
```{r echo=FALSE, warning=FALSE}
field_data_plot
```


```{r echo=FALSE}
gdd_deadline_plots
```
```{r echo=FALSE}
plot_grid(ggplot(filter(gdd400_jp, only_2008=="n"), aes(x=year, y=gdd400, color=pop)) + geom_point() + geom_line() + theme_bw() + stat_smooth(method=lm, se=FALSE) + xlab("Year") + ylab("GDD Deadline"),ggplot(gdd400_us, aes(x=year, y=gdd400, color=pop)) + geom_point() + geom_line() + theme_bw() + stat_smooth(method=lm, se=FALSE) + xlab("Year") + ylab("GDD Deadline"), labels="AUTO")

```

```{r echo=FALSE, warning=FALSE}
gdd_by_interval<-ggplot(filter(interval_summaries, CPP_YEAR==2018), aes(x=latitude, y=gdd400_mean, fill=country, shape=interval)) + 
  geom_point(size=3) + scale_fill_manual(values=c("black", "gray"), name="Country") + scale_shape_manual(values=c(21,24), name="Period") + geom_errorbar(aes(ymin=gdd400_mean-gdd400_sd, ymax=gdd400_mean+gdd400_sd, color=country)) +
  stat_smooth(method=lm, se=FALSE, aes(linetype=interval, color=country)) + scale_linetype_manual(values=c("dotted","solid"), name="Period") + 
  scale_color_manual(values=c("black","gray"), name="Country") +
  guides(fill=guide_legend(override.aes=list(shape=22)), linetype=guide_legend(override.aes=list(color="black")),
  color=guide_legend(override.aes=list(linetype=0)), color=guide_legend(override.aes=list(linetype=0)), linetype=guide_legend(legend.key.width=unit(3,"line"))) +
  theme_bw() + theme(legend.position=c(.8,.75), text=element_text(size=12)) + xlab("Latitude") + ylab("Mean GDD Deadline")

gdd_by_interval
```


```{r figs_for_poster, include=FALSE, echo=FALSE}
ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
     geom_point(size=6) + scale_color_manual(values=c("red", "blue")) +
     stat_smooth(method=lm, se=FALSE, aes(linetype=year)) + scale_linetype_manual(values=c("dotted","solid")) + theme_bw() + theme(legend.position=c(.8,.25), text=element_text(size=24)) + xlab("Latitude") + ylab("Critical photoperiod")
remove_geom(us_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="US", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(text=element_text(size=24), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null"))
remove_geom(japan_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="JP", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(text=element_text(size=24), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")) 
```


# References
