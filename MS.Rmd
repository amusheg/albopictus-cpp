---
title: "Ae albopictus CPP manuscript"
output:
  word_document: 
    fig_width: 3.5
    fig_height: 3
  html_document: default
---

```{r eval=FALSE, message=FALSE, include=FALSE}
install.packages("tidyverse") #1.2.1
install.packages("drc") #3.0.1
install.packages("stringr")
install.packages("geosphere")
install.packages("lubridate")
install.packages(c("maps", "mapdata"))
devtools::install_github("dkahle/ggmap")
install.packages("scatterpie")
install.packages("ggedit")
install.packages("cowplot")
```

```{r message=FALSE, echo=FALSE, include=FALSE}
library("drc") #3.0.1
library("knitr") #1.25
library("tidyverse") #1.2.1
library("stringr") #1.4.0
library("geosphere") #1.5.10
library("lubridate") #1.7.4
library("maps")
library("mapdata")
library("scatterpie")
library("ggedit")
library("cowplot")
```

```{r datasheet, echo=FALSE, include=FALSE}
all_data<-data.frame(read.csv("CPP_experiment_data_collated.csv"))
#Filter out empty/discarded oviposition papers 
blockAB<-dplyr::filter(all_data, TotalLarvaeEmbryos>0)
```

```{r yields, echo=FALSE, include=FALSE}
#Calculate yield/fraction of initial count
blockAB$yield <- blockAB$TotalLarvaeEmbryos/blockAB$InitialEggs 
hist(blockAB$yield, main="Yield (final/initial count) per oviposition paper")
plot(blockAB$yield ~ blockAB$TotalLarvaeEmbryos)
```

```{r filter papers, echo=FALSE, include=FALSE}
#removing papers with <60% or >100% initial count
blockAB_unfiltered<-blockAB
blockAB_filtered <- filter(blockAB, yield<=1) %>% filter(yield>=0.6) 
```

```{r summarize, echo=FALSE, include=FALSE}
DI_summarize <- function(blockAB) {
DI_summary <- blockAB %>% 
  group_by(CageID) %>% 
  summarise(pop=first(Population), pp=mean(Photoperiod), lat=mean(Lat), block=first(Block), country=first(Country), h1=sum(H1Count), h2=sum(H2Count), emb=sum(EmbryoCount)) %>% 
  filter(h1+h2+emb>100)
DI_summary$total<-DI_summary$h1+DI_summary$h2+DI_summary$emb
DI_summary$DI<-DI_summary$emb/DI_summary$total
return(DI_summary)
}
```

```{r, echo=FALSE, include=FALSE}
DI_summary<-DI_summarize(blockAB_filtered)
```

```{r totals_plot, echo=FALSE, include=FALSE}
hist(DI_summary$total, main="Total number of viable eggs per cage")
  
```

```{r DI_plot, echo=FALSE, include=FALSE}
#plot with DI at 8 h shown as TWO DIFFERENT points (corresponding to two cabinets)
ggplot(DI_summary, aes(x=pp, y=DI, group=pop)) + geom_point() + facet_wrap(~pop)
  
```

```{r incidence_lat, echo=FALSE, include=FALSE}
DI_short<-filter(DI_summary, pp==8)
ggplot(DI_short, aes(x=lat, y=DI, color=country)) + geom_point() + theme_bw() +stat_smooth()
```

```{r CPP_calc_2018, echo=FALSE, include=FALSE}
#From Kevin Emerson
# the following fits the models of the given  using data from the
# data.frame d separately for the various treatments using a 5 parameter
# logistic model
d.model.fit <- drm(DI ~ pp, data = DI_summary, curveid = pop, fct = LL.5())
#plot(d.model.fit, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit, 50)
cpp_values<-data.frame(ED(d.model.fit, 50))
```

```{r CPP_calc_2008, echo=FALSE, include=FALSE}
DI_summary_2008<-data.frame(read.csv("CPP_2008.csv"))
d.model.fit.2008 <- drm(DI ~ photoperiod, data = DI_summary_2008, curveid = pop, fct = LL.5())
  
#plot(d.model.fit.2008, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit.2008, 50)
cpp_values_2008<-data.frame(ED(d.model.fit.2008, 50))
```

```{r collate_cpp_values, echo=FALSE, include=FALSE}
cpp_2018<-data.frame(ED(d.model.fit, 50))
cpp_2018<-rownames_to_column(cpp_2018, var="pop") 
cpp_2018$pop<-str_sub(cpp_2018$pop,3,5)
popdata_2018<-DI_summary %>% group_by(pop) %>% 
  summarize(lat=first(lat), country=first(country))
cpp_2018<-right_join(cpp_2018, popdata_2018, by="pop")
cpp_2018$year<-rep("2018", nrow(cpp_2018))
colnames(cpp_2018)[colnames(cpp_2018)=="Std..Error"] <- "StdError"
cpp_2008<-data.frame(ED(d.model.fit.2008, 50)) %>% rownames_to_column(var="pop")
cpp_2008$pop<-str_sub(cpp_2008$pop,3,5)
colnames(cpp_2008)[colnames(cpp_2008)=="Std..Error"] <- "StdError"
popdata_2008<-DI_summary_2008 %>% group_by(pop) %>% 
  summarize(country=first(country), lat=first(lat), year=first(year)) 
cpp_2008<-right_join(cpp_2008, popdata_2008, by="pop")
cpp_1988<-data.frame(read.csv("CPP_1988.csv")) 
cpp_1988$pop<-na_if(cpp_1988$pop, "NA")
cpp_1988$StdError<-na_if(cpp_1988$StdError, "NA")
cpp_2<-rbind(cpp_1988, cpp_2008, cpp_2018) 
write.csv(cpp_2, "cpp_calcs_filtered.csv")
```

```{r Japan_US_years, echo=FALSE, include=FALSE}
ggplot(cpp_2, aes(x=lat, y=Estimate, fill=year, color=year)) + 
  scale_color_manual(values=c("white","gray","black")) + 
  scale_fill_manual(values=c("white","gray","black"))+ 
  geom_point(shape=21, color="black") + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~country) + stat_smooth(method=lm, se=FALSE)
```

```{r cppmodel, echo=FALSE, include=FALSE}
cppmodel<-lm(Estimate~lat*country*year, data=filter(cpp_2, year!=1988))
anova(cppmodel)
```


```{r, echo=FALSE, include=FALSE}
ggplot(cpp_2, aes(x=lat, y=Estimate, color=country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~year) + stat_smooth(method=lm, se=FALSE)
```

```{r, echo=FALSE, include=FALSE}
ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
  geom_point() +
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  stat_smooth(method=lm, se=FALSE, aes(linetype=year)) 
```

```{r incidence_lat_year, echo=FALSE, include=FALSE}
DI_short_2008<-filter(DI_summary_2008, photoperiod==8)
DI_short_2018<-filter(DI_summary, pp==8) %>% group_by(pop) %>% 
  summarize(country=first(country), lat=first(lat), photoperiod=first(pp), emb=sum(emb), total=sum(total))
DI_short_2018$DI<-DI_short_2018$emb/DI_short_2018$total
DI_short_2018<-DI_short_2018[,c(1:4,7)] 
DI_short_2018$year<-rep("2018",nrow(DI_short_2018))
DI_short_2<-rbind(DI_short_2008, DI_short_2018)
write_csv(DI_short_2, "diapause_incidence_8h_2008_2018.csv")
incidence_lat_year_plot<-ggplot(DI_short_2, aes(x=lat, y=DI, color=year, label=pop)) + scale_color_manual(values=c("gray","black")) + 
  geom_point() + facet_grid(~country) 

country_DI_2018<-ggplot(DI_short_2018, aes(x=lat, y=DI, color=country)) + scale_color_manual(values=c("red","blue")) + geom_point() + theme_bw() + stat_smooth() + theme(legend.position="none")
```

```{r dimodel, echo=FALSE, include=FALSE}
dimodel<-lm(DI~lat*country*year, data=DI_short_2)
anova(dimodel)
```


```{r day_function, echo=FALSE, include=FALSE}
findDate<-function(lat, pp, year) {
#generate day lengths at latitude between July 1 and Dec 31
x<-daylength(lat,182:365)
#find position of day length in the daylength vector that is closest to photoperiod queried
daynumber<-which.min(abs(x-pp))
#convert day number to date
origin<-as.character(paste(year,"-07-01",sep=""))
return(as.character(as.Date(daynumber, origin=origin)))
}
```


```{r approx_dates, include=FALSE, echo=FALSE, include=FALSE}
cpp_2$date<-mapply(findDate, lat=cpp_2$lat, pp=cpp_2$Estimate, year=cpp_2$year)
cpp_2$estimated_date<-format(as.Date(cpp_2$date), "%mm-%dd")
cpp_2$estimated_date<-as.Date(cpp_2$estimated_date, format="%mm-%dd")
date_plot<-ggplot(cpp_2, aes(x=lat, y=estimated_date, color=year)) + geom_point() + scale_y_date(date_breaks = "weeks" , date_minor_breaks="days", date_labels = "%b-%d") +  facet_grid(~country) + theme_bw() + stat_smooth(method=lm, se=FALSE)
```

```{r maps, echo=FALSE, include=FALSE}
usa<-map_data("usa")
jp<-map_data("japan")
pops<-data.frame(read.csv("mapping_pops_cpp_expt.csv"))

us_map<-ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group=group), fill=NA, color="blue") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="US"), aes(x = longitude, y = latitude), size = 1) + xlim(c(-90, -65)) +
  geom_label(data=filter(pops, country=="US"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() 

japan_map<-ggplot() + geom_polygon(data = jp, aes(x=long, y = lat, group=group), fill=NA, color="red") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="JP", only_2008=="n"), aes(x = longitude, y = latitude), size = 1)  +
  geom_label(data=filter(pops, country=="JP"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

DI_data<-data.frame(read.csv("diapause_incidence_8h_2008_2018.csv"))
DI_data$ND<-1-DI_data$DI
DI_info<-full_join(DI_data, pops)
DI_info<-rename(DI_info, Diapause=DI, Nondiapause=ND)

us_DI_pies<-remove_geom(us_map, "label") + geom_scatterpie(data=filter(DI_info, country=="US"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + 
  facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

jp_DI_pies<-remove_geom(japan_map, "label") + geom_scatterpie(data=filter(DI_info, country=="JP"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + 
  facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

DI_pies_2018<-plot_grid(remove_geom(us_map, "label") + geom_scatterpie(data=filter(DI_info, country=="US", year=="2018"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none"), remove_geom(japan_map, "label") + geom_scatterpie(data=filter(DI_info, country=="JP", year=="2018"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none"), ncol=1, align="hv")
```

## Introduction

- Diapause is an important overwintering adaptation in many organisms
- This adaptation comes with trade-offs, but exactly what they are is unclear (winter phenotypes of diapausing organisms; life history strategies)
- Climate change may have unpredictable effects on growing seasons
- Invasive species provide natural experiments for rapid adaptation
- Aedes albopictus worldwide spread: diapause played a role 
- What is the continuing role of diapause in light of environmental change, continuing introductions/admixture, 

## Methods

### Mosquito population sampling and rearing
Mosquito populations were sampled in the eastern USA and Japan in 2018, at latitudes ranging from (Fig 1). Sampling locations are described in Table 1. Locations in the US were largely identical to locations sampled in 2008. (More details about field sampling.) At least 50 male and 50 female mosquitoes were used to initiate laboratory populations, except for SEN, which had X females and Y males. 

```{r table1, echo=FALSE}
kable(filter(pops, only_2008=="n")[,1:5], col.names=c("Population", "City", "Latitude", "Longitude", "Country"), caption="Table 1: 2018 Sampling Locations")
```

Populations were maintained in the laboratory for 3 or 4 generations prior to the experiment at 21C and 80% humidity under a 16:8h light:dark cycle. Larvae were reared in distilled water and fed a slurry of dog food and brine shrimp, while adults were fed organic raisins and blood-fed by human arm. Initial laboratory generations of larvae were reared in plastic storage containers, with one population per container and densities varying by population. Pupae were then transferred into one adult cage per population. Populations generally had at least 50 female and 50 male adults per generation, but the JAC population experienced visibly high mortality during the F2 generation. The larval generation immediately prior to the experiment was reared in 15 cm plastic petri dishes containing 30-40 larvae each, X dishes per population. Additional details of mosquito husbandry can be found in Supplementary File 1. 

### Critical photoperiod determination
To determine the critical photoperiod of each population, the following general procedure was used: Starting from the pupal stage, mosquitoes were divided among 12 different photoperiods and allowed to produce eggs. The proportion of diapause eggs at each photoperiod was determined, and a dose-response curve was constructed with respect to hours of light and proportion of eggs in diapause. The critical photoperiod was calculated as the number of hours of light at which 50% of the eggs produced were in diapause, excluding the fraction of constitutively non-diapausing eggs (i.e. the fraction that did not enter diapause at 8 hours of light). The experimental design and most of the equipment and experimental details were the same as those used in Urbanski et al 2012; additional details on all steps can be found in Supplementary File 1.

Due to the large number of populations and photoperiods, the experiment was conducted in two blocks. Each block contained half of the populations from each country; populations across the full range of latitudes were interspersed between the blocks. At beginning of each block, eggs were hatched by submerging oviposition papers in water with larval food for two days. Larvae were distributed among X 15 cm petri dishes containing 90 ml of a mixture of distilled water and larval food (5 L of water to 10 mL of food slurry) at a density of 30-40 larvae per dish. Larvae were transferred to clean dishes containing fresh water/food mixture three times a week until pupation. Larvae were kept in the controlled temperature room at 21 degrees, 80 percent humidity and 16:8 hours light:dark until they produced pupae.

Pupae from each population were collected, pooled across dishes, and haphazardly distributed amongst thirteen 1.5 L adult cages, corresponding to 12 photoperiod cabinets and an additional short-day (8h light) incubator. The total number of pupae added to each cage ranged from X to Y; subsequent pupal and adult mortality was not monitored. Approximately one week after the last pupae were added, cages were blood-fed, and a dark oviposition cup half-filled with water and lined with unbleached paper towel was added to each cage. Oviposition papers were collected 5-7 days after blood-feeding and replaced every 2-3 days; a total of four oviposition papers were collected from each cage. Several cages were fed again and an additional oviposition paper was collected; see Supplementary File 1 for details. Oviposition papers were dried gently and stored in the photoperiod cabinets for 10 to 21 days until the diapause scoring procedure.

Oviposition papers were trimmed to a ~2 cm strip surrounding what was the waterline in the oviposition cup; this zone generally contained the vast majority of the eggs. On papers with few eggs, the paper was trimmed in such a way as to capture all eggs. On papers with very dense oviposition, the egg-containing strip was haphazardly subsampled further, to several hundred eggs as approximated by eye. Eggs were counted and egg papers were submerged in distilled water with several drops of larval food. Larvae that hatched were counted two days later and papers were re-dried. After 1-2 weeks, hatch was induced again and second installment hatched larvae were counted. Oviposition papers were then treated overnight with a bleach solution to clear the chorion of the remaining eggs. Eggs containing a pharate larva were scored as embryonated and in diapause. The total number of hatched larvae and embryonated eggs was considered the number of viable eggs. Oviposition papers in which viable eggs made up less than 60% or more than 100% of the eggs initially counted on the paper were excluded from further analysis. Analysis dates, subsampling and other detailed information about each oviposition paper can be found in Data Table 1.

For each cage, the counts of larvae and embryos across all oviposition papers were pooled to calculate the diapause fraction: number of embryonated eggs divided by total number of viable eggs. The median total number of viable eggs per cage was `r median(DI_summary$total)` (range `r min(DI_summary$total)`-`r max(DI_summary$total)`). For the 8-hour photoperiod, each population had data from two cages: one in a photoperiod cabinet and one in a separate incubator. These data were pooled to calculate the diapause incidence value for the population, but used as separate data points in photoperiod response curves. 

### Statistical analysis
Critical photoperiod was calculated from photoperiod response curves as ED50 using a five-parameter generalized log-logistic model in the R (3.6.0) package drc (3.0.1). Effects of latitude, country and year (2008 vs. 2018) on CPP and on DI were analyzed with linear models. Additional packages used for calculations, analysis and figures included tidyverse (1.2.1), maps, mapdata, scatterpie…(update package list as figures come together).

## Results

Latitude-specific diapause incidence (the fraction of diapausing eggs produced under unambiguous short-day conditions) did not significantly differ between 2008 and 2018 in Japan or the US (Figure 1, Table 2). Diapause incidence was high (generally greater than 90%) at latitudes above ~32.5 degrees in both countries (Figure 2A). Substantial fractions of constitutively non-diapausing eggs were observed in populations south of South Carolina in the US and in Okinawa in Japan. Diapause incidence followed a latitudinal cline in the US, but a cline could not be observed in Japan due to absence of land to sample between Okinawa and Kagoshima. In the limited number of southern populations that could be compared between the US and Japan, latitude-specific diapause incidence appeared to be lower in the US (Figure 2B).

```{r fig1, fig.cap="Figure 1: Diapause incidence in Japan and US in 2008 and 2018", echo=FALSE}
incidence_lat_year_plot
```

```{r table2, echo=FALSE}
kable(anova(dimodel), digits=3, caption="Table 2")
```

```{r fig2, fig.cap="Figure 2: Diapause incidence (2018) by country. Black sections of pie charts represent diapausing fraction; white fractions represent non-diapausing. Blue points represent US diapause incidence; red points represent Japan.", echo=FALSE, message=FALSE}
plot_grid(DI_pies_2018, country_DI_2018, ncol=2, labels="AUTO")
```

As observed in 
