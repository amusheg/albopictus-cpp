---
title: "Ae. albopictus CPP manuscript"
header-includes: #allows you to add in your own Latex packages
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
output:
  word_document: default
  html_document: default
  pdf_document: default
bibliography: MyLibrary.bib
---

```{r eval=FALSE, message=FALSE, include=FALSE}
install.packages("tidyverse") #1.2.1
install.packages("drc") #3.0.1
install.packages("stringr")
install.packages("geosphere")
install.packages("lubridate")
install.packages(c("maps", "mapdata"))
devtools::install_github("dkahle/ggmap")
install.packages("scatterpie")
install.packages("ggedit")
install.packages("ggrepel")
install.packages("papeR")
install.packages("cowplot")
```

```{r message=FALSE, echo=FALSE, include=FALSE}
library("papeR")
library("drc") #3.0.1
library("knitr") #1.25
library("tidyverse") #1.2.1
library("stringr") #1.4.0
library("geosphere") #1.5.10
library("lubridate") #1.7.4
library("maps")
library("mapdata")
library("scatterpie")
library("ggedit")
library("ggrepel")
library("cowplot")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi=300)
```

```{r datasheet, echo=FALSE, include=FALSE}
all_data<-data.frame(read.csv("CPP_experiment_data_collated.csv"))
#Filter out empty/discarded oviposition papers 
blockAB<-dplyr::filter(all_data, TotalLarvaeEmbryos>0)
```

```{r yields, echo=FALSE, include=FALSE}
#Calculate yield/fraction of initial count
blockAB$yield <- blockAB$TotalLarvaeEmbryos/blockAB$InitialEggs 
hist(blockAB$yield, main="Yield (final/initial count) per oviposition paper")
plot(blockAB$yield ~ blockAB$TotalLarvaeEmbryos)
```

```{r filter papers, echo=FALSE, include=FALSE}
#removing papers with <60% or >100% initial count
blockAB_unfiltered<-blockAB
blockAB_filtered <- filter(blockAB, yield<=1) %>% filter(yield>=0.6) 
#test removing papers that had premature larval hatch on paper
#badpapers<-c("333-1", "334-1", "335-1", "336-1", "337-1", "338-1", "339-1", "340-1", "341-1", "342-1", "343-1","366-1", "367-1", "368-1", "369-1", "370-1", "371-1", "372-1", "373-1", "374-1", "375-1", "376-1")
#blockAB_filtered <- filter(blockAB, yield<=1) %>% filter(yield>=0.6) %>% filter(!PaperID %in% badpapers)
```

```{r summarize, echo=FALSE, include=FALSE}
DI_summarize <- function(blockAB) {
DI_summary <- blockAB %>% 
  group_by(CageID) %>% 
  dplyr::summarise(pop=first(Population), pp=mean(Photoperiod), lat=mean(Lat), block=first(Block), country=first(Country), h1=sum(H1Count), h2=sum(H2Count), emb=sum(EmbryoCount)) %>%   filter(h1+h2+emb>100)
DI_summary$total<-DI_summary$h1+DI_summary$h2+DI_summary$emb
DI_summary$DI<-DI_summary$emb/DI_summary$total
return(DI_summary)
}
```

```{r, echo=FALSE, include=FALSE}
DI_summary<-DI_summarize(blockAB_filtered)
```

```{r totals_plot, echo=FALSE, include=FALSE}
hist(DI_summary$total, main="Total number of viable eggs per cage")
```

```{r DI_plot, echo=FALSE, include=FALSE}
#plot with DI at 8 h shown as TWO DIFFERENT points (corresponding to two cabinets)
c("PBS", "FEM", "OAK", "JAC", "BRU", "ZIO", "FAY", "NVA", "WAV", "MAN", "BER", "NEW", "OKI", "TAN", "KAG", "YAT", "SAG", "SHI", "YAM", "HIR", "KYO", "TAK", "TOK", "UTS", "KAN", "KHO", "AIZ", "NIG", "SEN", "SAK")
DI_summary$pop<-factor(DI_summary$pop, levels=c("PBS", "FEM", "OAK", "JAC", "BRU", "ZIO", "FAY", "NVA", "WAV", "MAN", "BER", "NEW", "OKI", "TAN", "KAG", "YAT", "SAG", "SHI", "YAM", "HIR", "KYO", "TAK", "TOK", "UTS", "KAN", "KHO", "AIZ", "NIG", "SEN", "SAK"))
DI_plot<-ggplot(DI_summary, aes(x=pp, y=DI, group=pop)) + geom_point() + facet_wrap(~fct_reorder(pop, lat)) + theme_bw() + xlab("Photoperiod (hours)") + ylab("Dipause incidence")
  
```

```{r incidence_lat, echo=FALSE, include=FALSE}
DI_short<-filter(DI_summary, pp==8)
ggplot(DI_short, aes(x=lat, y=DI, color=country)) + geom_point() + theme_bw() +stat_smooth()
```

```{r CPP_calc_2018, echo=FALSE, include=FALSE}
#From Kevin Emerson
# the following fits the models of the given  using data from the
# data.frame d separately for the various treatments using a 5 parameter
# logistic model
d.model.fit <- drm(DI ~ pp, data = DI_summary, curveid = pop, fct = LL.5())
#plot(d.model.fit, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit, 50)
cpp_values<-data.frame(ED(d.model.fit, 50))
```

```{r CPP_calc_2008, echo=FALSE, include=FALSE}
DI_summary_2008<-data.frame(read.csv("CPP_2008.csv"))
d.model.fit.2008 <- drm(DI ~ photoperiod, data = DI_summary_2008, curveid = pop, fct = LL.5())
  
#plot(d.model.fit.2008, log = "")
# output the parameters of the model fits:
summary(d.model.fit)
# estimate the 50% intercept
ED(d.model.fit.2008, 50)
cpp_values_2008<-data.frame(ED(d.model.fit.2008, 50))
```

```{r collate_cpp_values, echo=FALSE, include=FALSE}
cpp_2018<-data.frame(ED(d.model.fit, 50))
cpp_2018<-rownames_to_column(cpp_2018, var="pop") 
cpp_2018$pop<-str_sub(cpp_2018$pop,3,5)
popdata_2018<-DI_summary %>% group_by(pop) %>% 
  dplyr::summarize(lat=first(lat), country=first(country))
cpp_2018<-right_join(cpp_2018, popdata_2018, by="pop")
cpp_2018$year<-rep("2018", nrow(cpp_2018))
colnames(cpp_2018)[colnames(cpp_2018)=="Std..Error"] <- "StdError"
cpp_2008<-data.frame(ED(d.model.fit.2008, 50)) %>% rownames_to_column(var="pop")
cpp_2008$pop<-str_sub(cpp_2008$pop,3,5)
colnames(cpp_2008)[colnames(cpp_2008)=="Std..Error"] <- "StdError"
popdata_2008<-DI_summary_2008 %>% group_by(pop) %>% 
  dplyr::summarize(country=first(country), lat=first(lat), year=first(year)) 
cpp_2008<-right_join(cpp_2008, popdata_2008, by="pop")
cpp_1988<-data.frame(read.csv("CPP_1988.csv")) 
cpp_1988$pop<-na_if(cpp_1988$pop, "NA")
cpp_1988$StdError<-na_if(cpp_1988$StdError, "NA")
cpp_2<-rbind(cpp_1988, cpp_2008, cpp_2018) 
write.csv(cpp_2, "cpp_calcs_filtered.csv")
```

```{r Japan_US_years, echo=FALSE, include=FALSE}
cpp_japan_us_years<-ggplot(cpp_2, aes(x=lat, y=Estimate, fill=year, color=year)) + 
  scale_color_manual(values=c("white","gray","black")) + 
  scale_fill_manual(values=c("white","gray","black"))+ 
  geom_point(shape=21, color="black") + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~country) + stat_smooth(method=lm, se=FALSE)
```

```{r cppmodel, echo=FALSE, include=FALSE}
cppmodel<-lm(Estimate~lat*country*year, data=filter(cpp_2, year!=1988))
cppmodel_result<-data.frame(anova(cppmodel))
```

```{r, echo=FALSE, include=FALSE}
ggplot(cpp_2, aes(x=lat, y=Estimate, color=country)) + 
  geom_point() + 
  geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) + 
  facet_grid(~year) + stat_smooth(method=lm, se=FALSE)
```

```{r, echo=FALSE, include=FALSE}
cpp_08_18_shifts<-ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
  geom_point(size=3) + scale_color_manual(values=c("red", "blue")) +
  stat_smooth(method=lm, se=FALSE, aes(linetype=year)) + scale_linetype_manual(values=c("dotted","solid")) + theme_bw() + theme(legend.position=c(.8,.25)) + xlab("Latitude") + ylab("Critical photoperiod")
  # + geom_errorbar(aes(ymin=Estimate-StdError, ymax=Estimate+StdError), na.rm=TRUE) 
```

```{r incidence_lat_year, echo=FALSE, include=FALSE}
DI_short_2008<-filter(DI_summary_2008, photoperiod==8)
DI_short_2018<-filter(DI_summary, pp==8) %>% group_by(pop) %>% 
  dplyr::summarize(country=first(country), lat=first(lat), photoperiod=first(pp), emb=sum(emb), total=sum(total))
DI_short_2018$DI<-DI_short_2018$emb/DI_short_2018$total
DI_short_2018<-DI_short_2018[,c(1:4,7)] 
DI_short_2018$year<-rep("2018",nrow(DI_short_2018))
DI_short_2<-rbind(DI_short_2008, DI_short_2018)
write_csv(DI_short_2, "diapause_incidence_8h_2008_2018.csv")
incidence_lat_year_plot<-ggplot(DI_short_2, aes(x=lat, y=DI, color=year, label=pop)) + scale_color_manual(values=c("gray","black")) + 
  geom_point() + facet_grid(~country) 

country_DI_2018<-ggplot(DI_short_2018, aes(x=lat, y=DI, color=country)) + scale_color_manual(values=c("red","blue")) + geom_point() + theme_bw() + stat_smooth() + theme(legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "cm"))

country_DI<-ggplot(filter(DI_short_2, year!=1988), aes(x=lat, y=DI, color=country)) + scale_color_manual(values=c("red","blue")) + geom_point() + theme_bw() + stat_smooth() + theme(legend.position=c(0.9,0.1)) + facet_grid(~year)


```

```{r dimodel, echo=FALSE, include=FALSE}
dimodel<-lm(DI~lat*country*year, data=DI_short_2)
dimodel_result<-data.frame(anova(dimodel))
```


```{r day_function, echo=FALSE, include=FALSE}
findDate<-function(lat, pp, year) {
#generate day lengths at latitude between July 1 and Dec 31
x<-daylength(lat,182:365)
#find position of day length in the daylength vector that is closest to photoperiod queried
daynumber<-which.min(abs(x-pp))
#convert day number to date
origin<-as.character(paste(year,"-07-01",sep=""))
return(as.character(as.Date(daynumber, origin=origin)))
}
```


```{r approx_dates, include=FALSE, echo=FALSE, include=FALSE}
cpp_2$date<-mapply(findDate, lat=cpp_2$lat, pp=cpp_2$Estimate, year=cpp_2$year)
cpp_2$estimated_date<-format(as.Date(cpp_2$date), "%mm-%dd")
cpp_2$estimated_date<-as.Date(cpp_2$estimated_date, format="%mm-%dd")
date_plot<-ggplot(cpp_2, aes(x=lat, y=estimated_date, color=year)) + geom_point() + scale_y_date(date_breaks = "weeks" , date_minor_breaks="days", date_labels = "%b-%d") +  facet_grid(~country) + theme_bw() + stat_smooth(method=lm, se=FALSE)
```

```{r maps, echo=FALSE, include=FALSE}
usa<-map_data("usa")
jp<-map_data("japan")
pops<-data.frame(read.csv("mapping_pops_cpp_expt.csv"))

us_map<-ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group=group), fill=NA, color="blue") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="US"), aes(x = longitude, y = latitude), size = 1) + xlim(c(-85, -65)) +
  geom_label(data=filter(pops, country=="US"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() 

japan_map<-ggplot() + geom_polygon(data = jp, aes(x=long, y = lat, group=group), fill=NA, color="red") + 
  coord_fixed(1.3) + geom_point(data = filter(pops, country=="JP", only_2008=="n"), aes(x = longitude, y = latitude), size = 1)  + xlim(c(125, 147)) +
  geom_label_repel(data=filter(pops, country=="JP", only_2008=="n"), aes(x=longitude, y=latitude, label=pop), hjust=0, label.padding=unit(0.1, "lines")) +
  theme_bw() + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

DI_data<-data.frame(read.csv("diapause_incidence_8h_2008_2018.csv"))
DI_data$ND<-1-DI_data$DI
DI_info<-full_join(DI_data, pops)
DI_info<-rename(DI_info, Diapause=DI, Nondiapause=ND)

us_DI_pies<-remove_geom(us_map, "label") + geom_scatterpie(data=filter(DI_info, country=="US"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

jp_DI_pies<-remove_geom(japan_map, "label") + geom_scatterpie(data=filter(DI_info, country=="JP"), aes(x=longitude, y=latitude, r=0.5), cols=c("Diapause", "Nondiapause")) + 
  facet_grid(~year) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

DI_pies_2018<-plot_grid(remove_geom(us_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="US", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")), 
                        
remove_geom(japan_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="JP", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")), ncol=2, align="hv")
```

## Introduction

- Diapause is an important overwintering adaptation in many organisms
- Photoperiod provides a reliable signal of time of year and so is used by many organisms to regulate seasonal strategies
- The optimal time of year to go into diapause might depend on a lot of different climactic factors and fitness considerations
- Climate change may have unpredictable effects on growing seasons
- Invasive species provide natural experiments for rapid adaptation
- Aedes albopictus worldwide spread: diapause played a role 
- What is the continuing role of diapause in light of environmental change, continuing introductions, competing selective pressures? 
- We recapitulated 2008 CPP study using the same experimental design and methods

## Methods

### Mosquito population sampling and pre-experiment colony maintenance
Mosquito populations were sampled as larvae and pupae in the eastern USA and Japan in June-September 2018, at latitudes ranging from `r min(pops$latitude)` to `r max(pops$latitude)`. Sampling locations are described in Table 1. Locations in the US were identical to locations sampled in 2008. Japanese population samples were confirmed to be Ae. albopictus via morphological identification following [@tanakaRevisionAdultLarval1979] and sent to Georgetown as F1 eggs (except for TAK, for which F2 eggs were provided). At least 50 male and 50 female adult mosquitoes were used to initiate all populations in the laboratory at Georgetown, except for SEN, which had 37 females and 39 males.  

```{r table1, echo=FALSE}
kable(filter(pops, only_2008=="n")[,1:6], col.names=c("Population", "City", "Latitude", "Longitude", "Country", "Life Stage Sampled"), caption="Table 1: 2018 Sampling Locations")
```

Populations were maintained in the laboratory for 3 or 4 generations prior to the experiment at 21C and 80% relative humidity under a 16:8h light:dark cycle, following previous studies [@armbrusterGeographicVariationLarval2006; @urbanskiRapidAdaptiveEvolution2012]. Larvae were reared in distilled water and fed a slurry of dog food and brine shrimp. Adults were provided organic raisins as a carbohydrate source and blood meals from a human host. Initial laboratory generations of larvae were reared in plastic storage containers containing ~2.5 L of distilled water, with one population per container at initial densities of ~200-300, for ease of bulk rearing. Pupae were then transferred into one adult cage per population. Populations generally had at least 50 female and 50 male adults per generation, but the JAC population experienced visibly high mortality during the F2 generation. The larval generation immediately prior to the experiment was reared in 15 cm plastic petri dishes containing 30-40 larvae each, 10 dishes per population, to match the larval rearing conditions of the experimental generation, which followed the methods of Urbanski et al 2012. Additional details of mosquito husbandry prior to the experiment can be found in Supplementary File 1. 

### Critical photoperiod determination
An overview of the procedure used to determine the critical photoperiod (CPP) is as follows: Starting from the pupal stage, mosquitoes were divided among 12 different photoperiods (listed in Supplementary File 1) and allowed to produce eggs. The proportion of diapause eggs at each photoperiod was determined, and a dose-response curve was constructed with respect to hours of light and proportion of eggs in diapause. The critical photoperiod was calculated as the number of hours of light at which 50% of the eggs produced were in diapause, excluding the fraction of constitutively non-diapausing eggs (i.e. the fraction that did not enter diapause under unambigous short-day conditions, 8 hours of light). This experimental design and most of the equipment and experimental details were the same as those used in Urbanski et al 2012; additional details on all steps can be found in Supplementary File 1. 

Due to the large number of populations and photoperiods, the experiment was conducted in two blocks. Each block contained half of the populations from each country; populations across the full range of latitudes from each country were interspersed between the blocks. At the beginning of each block, eggs were hatched by submerging oviposition papers in distilled water with larval food for two days. Larvae were distributed among 40 15 cm petri dishes containing 90 ml of a mixture of distilled water and larval food (5 L of water to 10 mL of food slurry) at a density of 30-40 larvae per dish. Larvae were transferred to clean dishes containing fresh water/food mixture every Monday-Wednesday-Friday (MWF) until pupation. Larvae were kept in the controlled temperature room at 21C, 80% humidity and 16:8 hours light:dark until they produced pupae.

Pupae from each population were collected, pooled across dishes, and split amongst thirteen 1.5 L adult cages, corresponding to twelve photoperiod cabinets and an additional short-day (8h light) incubator to provide additional data on unambiguous short-day diapause incidence. The total number of pupae added to each cage ranged from 52 to 106; pupae were not sexed and subsequent pupal and adult mortality was not monitored. Approximately one week after the last pupae were added, cages were offered a blood meal, and a dark oviposition cup half-filled with water and lined with unbleached paper towel was added to each cage. Oviposition papers were collected 5-7 days after the blood meal and replaced every MWF; a total of four oviposition papers were collected from each cage. Several cages were fed again and an additional oviposition paper was collected; see supplemental methods for details. Oviposition papers were dried gently and stored in the photoperiod cabinets from which they originated for 11 to 21 days until diapause determination. 

On each oviposition paper, eggs were counted (subsampling if oviposition was very high; see supplemental methods) and papers were submerged in distilled water with ~0.25 ml larval food. Larvae that hatched were counted two days later and papers were re-dried and stored as before. After 1-2 weeks, hatch was induced again and larvae were counted. Oviposition papers were then treated overnight with a bleach solution to clear the chorion of the remaining eggs [@trpisNewBleachingDecalcifying1970] . Eggs were examined under a stereomicroscope, and those eggs containing a pharate larva were scored as embryonated and in diapause. The total number of hatched larvae and embryonated eggs was considered the number of viable eggs. Oviposition papers in which viable eggs made up less than 60% or more than 100% of the eggs initially counted on the paper were excluded from further analysis. Analysis dates, subsampling and other detailed information about each oviposition paper can be found in Data Table 1.

For each cage, the counts of larvae and embryos across all oviposition papers were pooled to calculate the diapause incidence, or the fraction of total viable eggs that are in diapause (# embryonated / (# embryonated + # hatched)). The median total number of viable eggs per cage was `r median(DI_summary$total)` (range `r min(DI_summary$total)`-`r max(DI_summary$total)`). For the 8-hour photoperiod, each population had data from two cages: one in a photoperiod cabinet and one in a separate incubator. These data were pooled to calculate the value for diapause incidence at unambiguous short-day (DI) for the population, but used as separate data points in photoperiod response curves. 

Photoperiod response data from 2008 were obtained from the data files of Urbanski et al 2012 (doi:10.5061/dryad.68277435).

### Statistical analysis
Critical photoperiod was calculated from photoperiod response curves (Figure S1) as ED50 using a five-parameter generalized log-logistic model in the R (3.6.0) package drc (`r packageVersion("drc")`). Effects of latitude, country and year (2008 vs. 2018) on CPP and on DI were analyzed with linear models. Data manipulation and figure construction were carried out using packages in tidyverse (`r packageVersion("tidyverse")`).

## Results

Latitude-specific DI (the fraction of diapausing eggs produced under unambiguous short-day conditions) did not significantly differ between 2008 and 2018 in Japan or the US (p=0.94, Figure 2, Table 2).  DI was high (generally greater than 90%) at latitudes north of ~32.5 degrees in both countries. Substantial fractions of constitutively non-diapausing eggs were observed in populations south of South Carolina in the US and in Okinawa in Japan (latitude effect p=<0.001). Latitude-specific DI was lower in the US than in Japan (country effect p=0.026), though there were fewer sites sampled at lower latitudes in Japan than the US due to lack of land between Okinawa and Kagashima. 

```{r fig.cap="Figure 1: Diapause incidence in Japan and US in 2008 and 2018", echo=FALSE, include=FALSE}
incidence_lat_year_plot
```

```{r fig.cap="Figure 2B: Diapause incidence by country and year. Lines represent locally estimated scatterplot smoothing (LOESS). Solid lines, 2018 data; dotted lines, 2008 data.", echo=FALSE, message=FALSE}
#country_DI
ggplot(filter(DI_short_2, year!=1988), aes(x=lat, y=DI, color=country, shape=year)) + scale_color_manual(values=c("red","blue")) + geom_point(size=3) + theme_bw() + theme(legend.position=c(0.9,0.3)) + stat_smooth(aes(linetype=year), se=FALSE) + scale_linetype_manual(values=c("dotted","solid")) + xlab("Latitude") + ylab("Short-day diapause incidence")

```

```{r echo=FALSE}
kable(prettify(anova(dimodel)), digits=3, caption="Table 2: Effects of latitude, country and year (2008 vs 2018) on diapause incidence.")
```

CPP values correlated strongly with latitude in the US and Japan (p<0.001, Table 3). Latitudinal clines were nearly parallel to those observed in 2008 (Figure 3), as verified by the lack of a significant interaction term between year and latitude (p=0.17). However, the intercepts of the latitudinal clines significantly differed between both the US and Japan, and between 2008 and 2018 (p<0.001 for both country and year). Latitude-specific CPP was higher in Japan than the US, and higher in 2018 compared to 2008. This implies earlier entry into diapause at the same latitude in Japan than in the US, as well as earlier entry into diapause in the same locations in 2018 than in 2008. 

```{r fig.cap="Figure 3: Critical photoperiod (CPP) as a function of latitude in the US and Japan in 1988, 2008, and 2018. Error bars represent standard errors of CPP estimates. Errors around 1988 CPP estimates are absent because experiment and calculations were conducted using different methods and raw data were not available.", echo=FALSE, message=FALSE, include=FALSE}
cpp_japan_us_years
```


```{r fig.cap="Figure 4: Shifts in critical photoperiod latitudinal clines. Lines represent linear regressions. Solid lines, 2018; dotted lines, 2008.", echo=FALSE}
cpp_08_18_shifts
```

```{r table3, echo=FALSE}
kable(prettify(anova(cppmodel)), caption="Table 3: Effects of latitude, country and year on critical photoperiod in 2008 and 2018.")
```

## Supplementary File 1

## Supplementary methods

### Larval rearing
Larvae were fed a slurry of 40 g frozen brine shrimp (San Francisco Bay Brand) and 120 g dog food (Nutro Feed Clean Ultra Small Breed Puppy formula) homogenized in 1 L of distilled water. Larvae were initially raised in plastic storage containers (Sterilite) containing 2.5 L of distilled water. Every Monday-Wednesday-Friday (MWF), the water in each container was removed by straining through a net and replaced with fresh distilled water; each container was fed approximately 1.5 ml of larval food slurry. Containers were covered with a fine mesh and kept at 21C, 80% humidity, and 16:8 L:D photoperiod. Starting with the generation prior to the one used in the experiment, larvae were reared in 15 cm petri dishes (Kord-Valmark), as in Urbanski et al 2012. The pre-experiment generation was fed ~0.5-0.6 ml larval food per dish, while the experimental generation had food/water concentrations as described in the main manuscript. Every MWF, larvae were transferred to clean petri dishes with a pipette and had fresh food/water added. When removing pupae substantially reduced the density of larvae, the remaining larvae were consolidated into fewer dishes. 

### Photoperiod cabinets 
The custom-built photoperiod cabinets were the same ones used in Urbanski et al 2012, described in detail in the Appendix (https://www.journals.uchicago.edu/doi/suppl/10.1086/664709/suppl_file/53244apa.pdf). The light-dark cycles used were 8L : 16D, 12L : 12D, 12.5L : 11.5D, 12.75L : 11.25D, 13L : 11D, 13.25L : 10.75D, 13.5L : 10.5D, 13.75L : 10.25D, 14L : 10D, 14.25L : 9.75D, 14.5L : 9.5D, and 16L : 8D. Light and temperature inside cabinets were recorded for at least three full days for each cabinet in each block. The highest recorded temperature in any cabinet at any point was 22.65C, the lowest was 20.72C, and 70% of temperature readings were between 21C and 22C. All light:dark cycles were within 1 minute of desired photoperiod except for the separate short-day incubator (Cabinet 13 in Data Table 1), which was within 5 minutes of 8 hours of light (7:59 -8:05). Cages in photoperiod cabinets were monitored daily for desiccation and mold; water was added to cages and raisins were replaced as needed. 

### Blood meals, egg collection and storage
Adult cages were fed from a human host over a three-day period; feeding days were randomly assigned by photoperiod cabinet. Collected oviposition papers were stored in 10 cm petri dishes inside humidified containers in the photoperiod cabinet in which they originated. In the second block of the experiment, two cages produced less than 200 eggs after the initial blood meal, and the cages in the cabinets with 14.5 hours and 14.25 hours of light had large numbers of larvae that hatched on the wet oviposition paper on the first egg collection day due to incomplete drying and thus could not be accurately counted. These 24 cages were offered a second blood meal and an additional oviposition paper was collected a week later. Papers with eggs produced after a second blood meal have a Paper ID ending in “-5” in Data Table 1.

### Diapause determination
Oviposition papers were trimmed to a ~2 cm strip surrounding the former location of the waterline in the oviposition cup; this zone generally contained the vast majority of the eggs. On oviposition papers with few eggs, the paper was trimmed in such a way as to capture all of them. On papers with very dense oviposition, the egg-containing strip was haphazardly subsampled further, to several hundred eggs as approximated by eye. 

After eggs were bleached, presence of pharate larvae was determined using the diagnostic criteria of visible eye spots and abdominal segmentation. On some oviposition papers, larvae “hatched” out of the eggs after the bleach solution was added; these were scored as embryonated diapause eggs because they appeared to be morphologically normal and did not hatch when induced with standard hatching cues twice. 

The total number of hatched larvae and embryos could differ from the number of eggs initially counted on the paper for the following reasons: 1) presence of inviable eggs or larvae (i.e., eggs that fail to hatch due to developmental abnormalities or larvae that die before being counted), 2) loss of eggs while handling oviposition papers, or 3) inaccurate counting at any step of the scoring process. Based on the distribution of percent differences from the initial counts (Figure S1), we considered oviposition papers with over 100% or less than 60% of the initial count to be less reliable data points. Excluding these data points resulted in 5 cages out of 286 in the total data set having less than 100 remaining eggs, so they were excluded from the photoperiod response curves. These filtering steps and exclusions did not affect CPP estimates for any population except PBS; for this population, excluding the unreliable counts eliminated an outlier in the photoperiod response curve and brought the CPP estimate into the range of CPP values for the rest of the populations (Figure S2). The final photoperiod response curves are shown in Figure S3.

```{r fig.cap="Figure S1: Discrepancies between initial egg counts and final calculated egg counts on oviposition papers.", echo=FALSE}
plot(blockAB$yield ~ blockAB$TotalLarvaeEmbryos, xlab="Number of viable eggs on oviposition paper", ylab="Viable eggs/initial egg count on paper")
```

```{r fig.cap="Figure S2. Critical photoperiod calculated with and without filtering oviposition papers based on criteria described. Line represents x=y. Outlier point corresponds to population PBS.", echo=FALSE}
#comparing CPP values calculated with and without filtering out unreliable oviposition papers
cpp_filtered<-read.csv("cpp_calcs_filtered.csv") %>% filter(year==2018)
cpp_unfiltered<-read.csv("cpp_calcs_unfiltered.csv") %>% filter(year==2018)
names(cpp_filtered)[5]<-"CPP_est_filt"
names(cpp_unfiltered)[5]<-"CPP_est_unfilt"
cpp_compare<-left_join(cpp_filtered,cpp_unfiltered,by="pop")
ggplot(cpp_compare, aes(x=CPP_est_unfilt, y=CPP_est_filt)) + geom_point() + geom_abline(slope=1, intercept=0) + xlab("CPP without filtering criteria") + ylab("CPP calculated with filtering criteria") + theme_bw()

```

```{r fig.cap="Figure S3: Photoperiod response curves", echo=FALSE}
DI_plot 
```

```{r fig.cap="Supplemental figure TBD. Diapause incidence (2018) by country. Dark sections of pie charts represent diapausing fraction; white fractions represent non-diapausing.", echo=FALSE, message=FALSE}
DI_pies_2018
```

```{r figs_for_poster, include=FALSE, echo=FALSE}
ggplot(filter(cpp_2, year!=1988), aes(x=lat, y=Estimate, color=country, shape=year)) + 
     geom_point(size=6) + scale_color_manual(values=c("red", "blue")) +
     stat_smooth(method=lm, se=FALSE, aes(linetype=year)) + scale_linetype_manual(values=c("dotted","solid")) + theme_bw() + theme(legend.position=c(.8,.25), text=element_text(size=24)) + xlab("Latitude") + ylab("Critical photoperiod")

remove_geom(us_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="US", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(text=element_text(size=24), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null"))

remove_geom(japan_map, "label") %>% remove_geom("point") + ylim(24,48) + geom_scatterpie(data=filter(DI_info, country=="JP", year=="2018"), aes(x=longitude, y=latitude, r=.7, alpha=0.95), cols=c("Diapause", "Nondiapause")) + scale_fill_manual(values=c("black","white")) + theme(text=element_text(size=24), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), legend.position="none", plot.margin = unit(c(0, 0, 0, 0), "null")) 

```

```{r}
```



# References
